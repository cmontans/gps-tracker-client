<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GPS Tracker">
  <meta name="theme-color" content="#4F46E5">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR1BTIFNwZWVkIFRyYWNrZXIiLCJzaG9ydF9uYW1lIjoiR1BTIFRyYWNrZXIiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzRGNDZFNSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDY2lyY2xlIGN4PSc1MCcgY3k9JzUwJyByPSc0MCcgZmlsbD0nJTIzNEY0NkU1Jy8lM0UlM0N0ZXh0IHg9JzUwJyB5PSc2MCcgZm9udC1zaXplPSc0MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nd2hpdGUnJTNF8J+agCUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDY2lyY2xlIGN4PSc1MCcgY3k9JzUwJyByPSc0MCcgZmlsbD0nJTIzNEY0NkU1Jy8lM0UlM0N0ZXh0IHg9JzUwJyB5PSc2MCcgZm9udC1zaXplPSc0MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nd2hpdGUnJTNF8J+agCUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
  <title>GPS Speed Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      overscroll-behavior: contain;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }
    * {
      box-sizing: border-box;
    }
    @media (display-mode: standalone) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 m-0 p-0">
  <div id="app" class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">üöÄ GPS Speed Tracker</h1>
        <p class="text-gray-600">Telemetr√≠a de velocidad en tiempo real</p>
        <p class="text-xs text-gray-400 mt-2">v2.1 - Optimizado para segundo plano ‚úì</p>
        <div id="wake-lock-status" class="hidden mt-2 text-xs">
          <span class="bg-green-100 text-green-800 px-2 py-1 rounded">üîí Pantalla bloqueada</span>
        </div>
      </div>

      <!-- Configuraci√≥n -->
      <div id="config-section" class="bg-white rounded-lg shadow-lg p-6 mb-4">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Tu Nombre
          </label>
          <input
            id="user-name"
            type="text"
            maxlength="20"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="Ej: Juan, Mar√≠a, Alex..."
          />
          <p class="text-xs text-gray-500 mt-1">As√≠ te ver√°n los dem√°s usuarios</p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            URL del Servidor WebSocket
          </label>
          <input
            id="server-url"
            type="text"
            value="wss://gps-tracker-server-production-5900.up.railway.app"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-2"
            placeholder="wss://tu-servidor.up.railway.app"
          />
          <p class="text-sm text-gray-500">
            ID: <span id="user-id" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded"></span>
          </p>
        </div>
      </div>

      <!-- Estado -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
          <div class="flex items-center gap-2">
            <span id="wifi-icon" class="text-2xl">üì°</span>
            <span id="connection-status" class="text-sm font-medium">Desconectado</span>
          </div>
          <div class="flex items-center gap-2">
            <span id="gps-icon" class="text-2xl">üìç</span>
            <span id="gps-status" class="text-sm font-medium">GPS Inactivo</span>
          </div>
        </div>

        <!-- Velocidad -->
        <div class="text-center py-8">
          <div class="mb-4">
            <div class="text-sm text-gray-600 mb-1">Velocidad Actual</div>
            <div id="speed-display" class="text-7xl font-bold text-indigo-600 mb-2">0</div>
            <div class="text-2xl text-gray-600">km/h</div>
          </div>
          
          <div class="grid grid-cols-2 gap-4 mt-6">
            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4">
              <div class="text-xs text-green-600 font-semibold mb-1">üèÜ M√ÅXIMA SESI√ìN</div>
              <div id="max-speed" class="text-3xl font-bold text-green-700">0</div>
              <div class="text-sm text-green-600">km/h</div>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4">
              <div class="text-xs text-blue-600 font-semibold mb-1">üìä PROMEDIO</div>
              <div id="avg-speed" class="text-3xl font-bold text-blue-700">0</div>
              <div class="text-sm text-blue-600">km/h</div>
            </div>
          </div>
        </div>

        <!-- Error -->
        <div id="error-box" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>

        <!-- Success -->
        <div id="success-box" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm"></div>

        <!-- Info adicional -->
        <div id="gps-info" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 text-sm">
          <p class="mb-1"><strong>Precisi√≥n GPS:</strong> <span id="accuracy">--</span> metros</p>
          <p class="mb-1"><strong>Coordenadas:</strong> <span id="coords" class="text-xs">--</span></p>
        </div>

        <!-- Bot√≥n -->
        <div class="mt-6">
          <button
            id="track-button"
            class="w-full bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
          >
            Iniciar Seguimiento
          </button>
        </div>
      </div>

      <!-- Usuarios -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <span class="text-2xl">üë•</span>
            Usuarios Conectados (<span id="user-count">0</span>)
          </h2>
          <button
            id="toggle-map-button"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
          >
            üó∫Ô∏è Ver Mapa
          </button>
        </div>
        <div id="users-list" class="space-y-3">
          <p class="text-gray-500 text-center py-8">No hay usuarios conectados</p>
        </div>
      </div>

      <!-- Mapa -->
      <div id="map-container" class="hidden bg-white rounded-lg shadow-lg p-6 mb-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <span class="text-2xl">üó∫Ô∏è</span>
            Mapa en Tiempo Real
          </h2>
          <button
            id="close-map-button"
            class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
          >
            ‚úï Cerrar
          </button>
        </div>
        <div id="map" class="w-full h-96 rounded-lg border-2 border-gray-200"></div>
        <div class="mt-4 text-sm text-gray-600">
          <p class="font-semibold mb-2">Leyenda:</p>
          <div class="flex flex-wrap gap-4">
            <div class="flex items-center gap-2">
              <span class="text-2xl">üìç</span>
              <span>Tu posici√≥n</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-2xl">üë§</span>
              <span>Otros usuarios</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="inline-block w-4 h-1 bg-blue-500"></span>
              <span>Trayectoria</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Instrucciones -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800 mb-4">
        <p class="font-semibold mb-2">üí° Pasos para usar:</p>
        <ol class="list-decimal list-inside space-y-1">
          <li>Introduce tu nombre</li>
          <li>Activa el GPS en tu m√≥vil</li>
          <li>Configura la URL del servidor</li>
          <li>Presiona "Iniciar Seguimiento"</li>
          <li>Permite acceso a ubicaci√≥n cuando te lo pida</li>
          <li>Sal al exterior para mejor se√±al GPS</li>
        </ol>
      </div>

      <!-- Instrucciones pantalla encendida -->
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 text-sm text-amber-800 mb-4">
        <p class="font-semibold mb-2">‚ö†Ô∏è Importante para GPS continuo:</p>
        <ul class="list-disc list-inside space-y-1">
          <li><strong>Android:</strong> La app mantendr√° la pantalla encendida autom√°ticamente. Baja el brillo para ahorrar bater√≠a.</li>
          <li><strong>iOS:</strong> Ve a Ajustes ‚Üí Pantalla ‚Üí Bloqueo autom√°tico ‚Üí "Nunca" mientras usas la app.</li>
          <li><strong>Instalar como app:</strong> Chrome/Safari ‚Üí Men√∫ ‚Üí "A√±adir a pantalla de inicio" para mejor rendimiento.</li>
        </ul>
      </div>

      <!-- Instrucciones iOS -->
      <div id="ios-instructions" class="hidden bg-purple-50 border border-purple-200 rounded-lg p-4 text-sm text-purple-800 mb-4">
        <p class="font-semibold mb-2">üçé Usuarios de iPhone/iPad:</p>
        <ol class="list-decimal list-inside space-y-1">
          <li>Abre esta p√°gina en <strong>Safari</strong> (no Chrome)</li>
          <li>Toca el bot√≥n "Compartir" (cuadrado con flecha arriba)</li>
          <li>Selecciona "A√±adir a pantalla de inicio"</li>
          <li>Abre la app desde el icono en tu pantalla</li>
          <li>Ve a Ajustes ‚Üí Safari ‚Üí Ubicaci√≥n ‚Üí "Permitir"</li>
          <li>Ajustes ‚Üí Privacidad ‚Üí Ubicaci√≥n ‚Üí Safari ‚Üí "Mientras se usa"</li>
        </ol>
      </div>
    </div>
  </div>

  <script>
    console.log('üöÄ GPS Tracker v2.1 iniciado');
    
    // Detectar iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    
    if (isIOS) {
      document.getElementById('ios-instructions').classList.remove('hidden');
      console.log('üì± Dispositivo iOS detectado');
    }
    
    // Variables globales
    let userId = localStorage.getItem('userId') || `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('userId', userId);
    
    let userName = localStorage.getItem('userName') || '';
    let ws = null;
    let watchId = null;
    let isTracking = false;
    let users = [];
    let wakeLock = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 10;
    
    // Variables para estad√≠sticas
    let maxSpeed = 0;
    let speedReadings = [];
    
    // Variables para el mapa
    let map = null;
    let userMarkers = {};
    let userTracks = {};
    let mapVisible = false;

    // Elementos DOM
    const elements = {
      userId: document.getElementById('user-id'),
      userName: document.getElementById('user-name'),
      serverUrl: document.getElementById('server-url'),
      configSection: document.getElementById('config-section'),
      wifiIcon: document.getElementById('wifi-icon'),
      connectionStatus: document.getElementById('connection-status'),
      gpsIcon: document.getElementById('gps-icon'),
      gpsStatus: document.getElementById('gps-status'),
      speedDisplay: document.getElementById('speed-display'),
      maxSpeed: document.getElementById('max-speed'),
      avgSpeed: document.getElementById('avg-speed'),
      errorBox: document.getElementById('error-box'),
      successBox: document.getElementById('success-box'),
      gpsInfo: document.getElementById('gps-info'),
      trackButton: document.getElementById('track-button'),
      userCount: document.getElementById('user-count'),
      usersList: document.getElementById('users-list'),
      accuracy: document.getElementById('accuracy'),
      coords: document.getElementById('coords'),
      wakeLockStatus: document.getElementById('wake-lock-status'),
      mapContainer: document.getElementById('map-container'),
      toggleMapButton: document.getElementById('toggle-map-button'),
      closeMapButton: document.getElementById('close-map-button')
    };

    // Inicializar
    elements.userId.textContent = userId.substring(0, 30);
    elements.userName.value = userName;

    // Guardar nombre cuando cambie
    elements.userName.addEventListener('input', (e) => {
      userName = e.target.value.trim();
      localStorage.setItem('userName', userName);
    });

    // Inicializar mapa con Leaflet (OpenStreetMap)
    function initMap(lat, lon) {
      if (map) return; // Ya est√° inicializado
      
      map = L.map('map').setView([lat, lon], 15);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
      
      console.log('‚úì Mapa inicializado');
    }

    // Calcular √°ngulo de direcci√≥n entre dos puntos
    function calculateBearing(lat1, lon1, lat2, lon2) {
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
      const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
      const bearing = Math.atan2(y, x) * 180 / Math.PI;
      return (bearing + 360) % 360;
    }

    // Crear icono de flecha para direcci√≥n
    function createArrowIcon(speed, isCurrentUser, bearing = 0) {
      const color = isCurrentUser ? '#4F46E5' : '#10B981';
      const size = isCurrentUser ? 30 : 25;
      
      return L.divIcon({
        html: `
          <div style="transform: rotate(${bearing}deg); width: ${size}px; height: ${size}px; display: flex; align-items: center; justify-content: center;">
            <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="${color}" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2L4 20L12 16L20 20L12 2Z" stroke="white" stroke-width="2"/>
            </svg>
          </div>
        `,
        className: 'custom-marker',
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
      });
    }

    // Actualizar mapa con posiciones de usuarios
    function updateMap() {
      if (!map || !mapVisible) return;

      users.forEach(user => {
        const isCurrentUser = user.userId === userId;
        
        // Crear o actualizar marcador
        if (!userMarkers[user.userId]) {
          const marker = L.marker([user.lat, user.lon], {
            icon: createArrowIcon(user.speed, isCurrentUser, user.bearing || 0)
          }).addTo(map);
          
          const displayName = user.userName || user.userId.substring(0, 15);
          marker.bindPopup(`
            <div class="text-center">
              <strong>${displayName}</strong><br>
              <span class="text-lg font-bold">${user.speed} km/h</span><br>
              <span class="text-xs text-gray-500">${new Date(user.timestamp).toLocaleTimeString()}</span>
            </div>
          `);
          
          userMarkers[user.userId] = marker;
          userTracks[user.userId] = [];
        } else {
          // Actualizar posici√≥n y rotaci√≥n
          const marker = userMarkers[user.userId];
          marker.setLatLng([user.lat, user.lon]);
          marker.setIcon(createArrowIcon(user.speed, isCurrentUser, user.bearing || 0));
          
          const displayName = user.userName || user.userId.substring(0, 15);
          marker.setPopupContent(`
            <div class="text-center">
              <strong>${displayName}</strong><br>
              <span class="text-lg font-bold">${user.speed} km/h</span><br>
              <span class="text-xs text-gray-500">${new Date(user.timestamp).toLocaleTimeString()}</span>
            </div>
          `);
        }
        
        // Agregar punto a la trayectoria
        const track = userTracks[user.userId];
        track.push([user.lat, user.lon]);
        
        // Mantener solo √∫ltimos 50 puntos
        if (track.length > 50) {
          track.shift();
        }
        
        // Dibujar trayectoria
        if (track.length > 1) {
          const color = isCurrentUser ? '#4F46E5' : '#10B981';
          L.polyline(track, {
            color: color,
            weight: 3,
            opacity: 0.7,
            smoothFactor: 1
          }).addTo(map);
        }
      });

      // Eliminar marcadores de usuarios desconectados
      Object.keys(userMarkers).forEach(uid => {
        if (!users.find(u => u.userId === uid)) {
          map.removeLayer(userMarkers[uid]);
          delete userMarkers[uid];
          delete userTracks[uid];
        }
      });

      // Centrar en el usuario actual si existe
      const currentUser = users.find(u => u.userId === userId);
      if (currentUser) {
        map.setView([currentUser.lat, currentUser.lon], map.getZoom());
      }
    }

    // Toggle mapa
    elements.toggleMapButton.addEventListener('click', () => {
      mapVisible = true;
      elements.mapContainer.classList.remove('hidden');
      
      // Inicializar mapa con posici√≥n del usuario actual
      const currentUser = users.find(u => u.userId === userId);
      if (currentUser) {
        initMap(currentUser.lat, currentUser.lon);
        updateMap();
      } else if (users.length > 0) {
        initMap(users[0].lat, users[0].lon);
        updateMap();
      }
      
      // Ajustar tama√±o del mapa
      setTimeout(() => {
        if (map) map.invalidateSize();
      }, 100);
    });

    elements.closeMapButton.addEventListener('click', () => {
      mapVisible = false;
      elements.mapContainer.classList.add('hidden');
    });

    // Wake Lock API - Mantener pantalla encendida
    async function requestWakeLock() {
      if (!('wakeLock' in navigator)) {
        console.log('‚ö†Ô∏è Wake Lock no soportado en este navegador');
        if (isIOS) {
          showError('En iOS: Ve a Ajustes ‚Üí Pantalla ‚Üí Bloqueo autom√°tico ‚Üí "Nunca"');
        }
        return;
      }

      try {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log('‚úì Wake Lock activado - Pantalla se mantendr√° encendida');
        elements.wakeLockStatus.classList.remove('hidden');
        showSuccess('‚úì Pantalla bloqueada - No se apagar√°');
        
        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock liberado');
          elements.wakeLockStatus.classList.add('hidden');
        });
      } catch (err) {
        console.log('‚ùå Wake Lock error:', err);
        if (isIOS) {
          showError('iOS: Configura "Bloqueo autom√°tico: Nunca" en Ajustes');
        }
      }
    }

    // Liberar Wake Lock
    function releaseWakeLock() {
      if (wakeLock) {
        wakeLock.release().then(() => {
          wakeLock = null;
          elements.wakeLockStatus.classList.add('hidden');
          console.log('‚úì Wake Lock liberado');
        });
      }
    }

    // Re-adquirir Wake Lock cuando la p√°gina vuelve a estar visible
    document.addEventListener('visibilitychange', async () => {
      if (isTracking && !document.hidden && wakeLock === null) {
        console.log('‚Üª Reactivando Wake Lock...');
        await requestWakeLock();
      }
    });

    // Prevenir que el navegador pause la app
    let keepAliveInterval = null;
    function startKeepAlive() {
      // Ping cada 25 segundos para mantener la conexi√≥n activa
      keepAliveInterval = setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'ping' }));
          console.log('üíì Keep-alive ping');
        }
      }, 25000);
    }

    function stopKeepAlive() {
      if (keepAliveInterval) {
        clearInterval(keepAliveInterval);
        keepAliveInterval = null;
      }
    }

    // Mostrar error
    function showError(message) {
      console.error('‚ùå', message);
      elements.errorBox.textContent = message;
      elements.errorBox.classList.remove('hidden');
      elements.successBox.classList.add('hidden');
      setTimeout(() => elements.errorBox.classList.add('hidden'), 8000);
    }

    // Mostrar √©xito
    function showSuccess(message) {
      console.log('‚úì', message);
      elements.successBox.textContent = message;
      elements.successBox.classList.remove('hidden');
      elements.errorBox.classList.add('hidden');
      setTimeout(() => elements.successBox.classList.add('hidden'), 3000);
    }

    // Actualizar estado de conexi√≥n
    function updateConnectionStatus(connected) {
      elements.wifiIcon.textContent = connected ? '‚úÖ' : '‚ùå';
      elements.connectionStatus.textContent = connected ? 'Conectado' : 'Desconectado';
      elements.connectionStatus.className = `text-sm font-medium ${connected ? 'text-green-600' : 'text-red-600'}`;
    }

    // Actualizar estado GPS
    function updateGpsStatus(active) {
      elements.gpsIcon.textContent = active ? '‚úÖ' : 'üìç';
      elements.gpsStatus.textContent = active ? 'GPS Activo' : 'GPS Inactivo';
      elements.gpsStatus.className = `text-sm font-medium ${active ? 'text-green-600' : 'text-gray-600'}`;
    }

    // Conectar WebSocket con reconexi√≥n mejorada
    function connectWebSocket() {
      const serverUrl = elements.serverUrl.value;
      console.log('üîå Conectando a:', serverUrl);
      
      try {
        ws = new WebSocket(serverUrl);
        
        ws.onopen = () => {
          updateConnectionStatus(true);
          showSuccess('‚úì Conectado al servidor');
          reconnectAttempts = 0;
          ws.send(JSON.stringify({ 
            type: 'register', 
            userId,
            userName: userName || 'Usuario'
          }));
          console.log('‚úì Registrado en servidor');
          startKeepAlive();
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'users') {
            users = data.users;
            updateUsersList();
            updateMap();
          } else if (data.type === 'pong') {
            console.log('üíì Pong recibido');
          }
        };

        ws.onerror = (error) => {
          console.error('‚ùå Error WebSocket:', error);
          showError('‚ö†Ô∏è Error de conexi√≥n. Verifica el servidor.');
          updateConnectionStatus(false);
        };

        ws.onclose = () => {
          console.log('üîå Conexi√≥n cerrada');
          updateConnectionStatus(false);
          stopKeepAlive();
          
          if (isTracking && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
            console.log(`‚Üª Reconectando en ${delay/1000}s (intento ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
            setTimeout(connectWebSocket, delay);
          } else if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
            showError('‚ùå No se pudo reconectar despu√©s de m√∫ltiples intentos');
          }
        };
      } catch (error) {
        console.error('‚ùå Error al crear WebSocket:', error);
        showError('No se pudo conectar: ' + error.message);
      }
    }

    // Actualizar lista de usuarios
    function updateUsersList() {
      elements.userCount.textContent = users.length;
      
      if (users.length === 0) {
        elements.usersList.innerHTML = '<p class="text-gray-500 text-center py-8">No hay usuarios conectados</p>';
        return;
      }

      elements.usersList.innerHTML = users.map(user => {
        const displayName = user.userName || user.userId.substring(0, 15);
        const isCurrentUser = user.userId === userId;
        
        // Calcular direcci√≥n en texto
        let direction = '';
        if (user.bearing !== undefined) {
          const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
          const index = Math.round(user.bearing / 45) % 8;
          direction = dirs[index];
        }
        
        return `
        <div class="p-4 rounded-lg border-2 ${isCurrentUser ? 'bg-indigo-50 border-indigo-300' : 'bg-gray-50 border-gray-200'}">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-lg font-semibold text-gray-800">${displayName}</span>
                ${isCurrentUser ? '<span class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-full">T√∫</span>' : ''}
              </div>
              <div class="text-xs text-gray-500 font-mono truncate">
                ID: ${user.userId.substring(0, 20)}...
              </div>
              <div class="flex items-center gap-3 mt-2 text-sm text-gray-600">
                <span>üß≠ ${direction || '--'}</span>
                <span>üèÜ ${user.maxSpeed || 0} km/h</span>
                <span class="text-xs">${new Date(user.timestamp).toLocaleTimeString()}</span>
              </div>
            </div>
            <div class="text-right ml-4">
              <div class="text-3xl font-bold text-indigo-600">${user.speed}</div>
              <div class="text-sm text-gray-600">km/h</div>
            </div>
          </div>
        </div>
      `}).join('');
    }

    // Iniciar seguimiento GPS
    function startTracking() {
      console.log('üéØ Iniciando seguimiento GPS...');
      
      // Validar nombre
      if (!userName || userName.trim() === '') {
        showError('‚ö†Ô∏è Por favor, introduce tu nombre antes de comenzar');
        elements.userName.focus();
        return;
      }
      
      if (!navigator.geolocation) {
        showError('‚ùå GPS no disponible en este dispositivo');
        return;
      }

      elements.configSection.classList.add('hidden');
      connectWebSocket();

      const options = {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      };

      let lastPosition = null;

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const speed = position.coords.speed !== null 
            ? Math.max(0, Math.round(position.coords.speed * 3.6))
            : 0;
          
          elements.speedDisplay.textContent = speed;
          updateGpsStatus(true);
          elements.gpsInfo.classList.remove('hidden');
          
          // Actualizar velocidad m√°xima
          if (speed > maxSpeed) {
            maxSpeed = speed;
            elements.maxSpeed.textContent = maxSpeed;
          }
          
          // Actualizar promedio
          speedReadings.push(speed);
          if (speedReadings.length > 20) speedReadings.shift(); // Mantener √∫ltimos 20
          const avgSpeed = Math.round(speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length);
          elements.avgSpeed.textContent = avgSpeed;
          
          // Calcular direcci√≥n/rumbo
          let bearing = 0;
          if (lastPosition && position.coords.speed > 1) { // Solo si hay movimiento
            bearing = calculateBearing(
              lastPosition.coords.latitude,
              lastPosition.coords.longitude,
              position.coords.latitude,
              position.coords.longitude
            );
          }
          
          const accuracy = Math.round(position.coords.accuracy);
          elements.accuracy.textContent = accuracy;
          elements.coords.textContent = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;

          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'speed',
              userId,
              userName: userName || 'Usuario',
              speed,
              maxSpeed,
              lat: position.coords.latitude,
              lon: position.coords.longitude,
              bearing: Math.round(bearing),
              timestamp: Date.now()
            }));
          }
          
          lastPosition = position;
        },
        (error) => {
          let errorMsg = '';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = '‚ùå Permisos denegados. Ve a Configuraci√≥n ‚Üí Permisos ‚Üí Ubicaci√≥n';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = '‚ö†Ô∏è GPS no disponible. Sal al exterior.';
              break;
            case error.TIMEOUT:
              errorMsg = '‚è±Ô∏è Tiempo agotado. Verifica que el GPS est√© activado.';
              break;
            default:
              errorMsg = '‚ùå Error GPS: ' + error.message;
          }
          showError(errorMsg);
          updateGpsStatus(false);
        },
        options
      );

      isTracking = true;
      elements.trackButton.textContent = 'Detener Seguimiento';
      elements.trackButton.className = 'w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-semibold py-3 px-6 rounded-lg transition-colors';
    }

    // Detener seguimiento
    function stopTracking() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      
      if (ws) {
        ws.close();
        ws = null;
      }
      
      stopKeepAlive();
      releaseWakeLock();
      
      // Resetear estad√≠sticas
      maxSpeed = 0;
      speedReadings = [];
      elements.maxSpeed.textContent = '0';
      elements.avgSpeed.textContent = '0';
      
      isTracking = false;
      reconnectAttempts = 0;
      updateGpsStatus(false);
      updateConnectionStatus(false);
      elements.speedDisplay.textContent = '0';
      elements.gpsInfo.classList.add('hidden');
      elements.configSection.classList.remove('hidden');
      elements.trackButton.textContent = 'Iniciar Seguimiento';
      elements.trackButton.className = 'w-full bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-semibold py-3 px-6 rounded-lg transition-colors';
    }

    // Evento del bot√≥n
    elements.trackButton.addEventListener('click', () => {
      if (isTracking) {
        stopTracking();
      } else {
        startTracking();
      }
    });

    // Limpiar al cerrar/recargar p√°gina
    window.addEventListener('beforeunload', () => {
      if (isTracking) {
        stopTracking();
      }
    });

    console.log('‚úì GPS Tracker listo');
    console.log('üì± iOS:', isIOS, '| Standalone:', isStandalone);
  </script>
</body>
</html>
