import React, { useState, useEffect, useRef } from 'react';
import { MapPin, Users, Wifi, WifiOff, Activity } from 'lucide-react';

export default function GPSSpeedTracker() {
  const [userId, setUserId] = useState('');
  const [speed, setSpeed] = useState(0);
  const [connected, setConnected] = useState(false);
  const [users, setUsers] = useState([]);
  const [error, setError] = useState('');
  const [gpsActive, setGpsActive] = useState(false);
  const [serverUrl, setServerUrl] = useState('ws://localhost:3001');
  
  const wsRef = useRef(null);
  const watchIdRef = useRef(null);

  // Generar ID 칰nico para el usuario
  useEffect(() => {
    const storedId = localStorage.getItem('userId') || `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('userId', storedId);
    setUserId(storedId);
  }, []);

  // Conectar al servidor WebSocket
  const connectWebSocket = () => {
    try {
      const ws = new WebSocket(serverUrl);
      
      ws.onopen = () => {
        setConnected(true);
        setError('');
        ws.send(JSON.stringify({ type: 'register', userId }));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'users') {
          setUsers(data.users);
        }
      };

      ws.onerror = () => {
        setError('Error de conexi칩n con el servidor');
        setConnected(false);
      };

      ws.onclose = () => {
        setConnected(false);
        setTimeout(() => {
          if (gpsActive) connectWebSocket();
        }, 3000);
      };

      wsRef.current = ws;
    } catch (err) {
      setError('No se pudo conectar al servidor');
    }
  };

  // Iniciar seguimiento GPS
  const startTracking = () => {
    if (!navigator.geolocation) {
      setError('GPS no disponible en este dispositivo');
      return;
    }

    connectWebSocket();

    const options = {
      enableHighAccuracy: true,
      timeout: 5000,
      maximumAge: 0
    };

    watchIdRef.current = navigator.geolocation.watchPosition(
      (position) => {
        const currentSpeed = position.coords.speed !== null 
          ? Math.round(position.coords.speed * 3.6) // Convertir m/s a km/h
          : 0;
        
        setSpeed(currentSpeed);
        setGpsActive(true);
        setError('');

        if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
          wsRef.current.send(JSON.stringify({
            type: 'speed',
            userId,
            speed: currentSpeed,
            lat: position.coords.latitude,
            lon: position.coords.longitude,
            timestamp: Date.now()
          }));
        }
      },
      (err) => {
        setError(`Error GPS: ${err.message}`);
        setGpsActive(false);
      },
      options
    );
  };

  // Detener seguimiento
  const stopTracking = () => {
    if (watchIdRef.current) {
      navigator.geolocation.clearWatch(watchIdRef.current);
      watchIdRef.current = null;
    }
    
    if (wsRef.current) {
      wsRef.current.close();
      wsRef.current = null;
    }
    
    setGpsActive(false);
    setConnected(false);
    setSpeed(0);
  };

  // Limpiar al desmontar
  useEffect(() => {
    return () => {
      stopTracking();
    };
  }, []);

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
          <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
            <Activity className="text-indigo-600" />
            GPS Speed Tracker
          </h1>
          <p className="text-gray-600">Telemetr칤a de velocidad en tiempo real</p>
        </div>

        {/* Configuraci칩n del servidor */}
        {!gpsActive && (
          <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              URL del Servidor WebSocket
            </label>
            <input
              type="text"
              value={serverUrl}
              onChange={(e) => setServerUrl(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              placeholder="ws://tu-servidor.com:3001"
            />
            <p className="text-sm text-gray-500 mt-2">
              ID de Usuario: <span className="font-mono text-xs">{userId}</span>
            </p>
          </div>
        )}

        {/* Estado y velocidad actual */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              {connected ? (
                <Wifi className="text-green-500" size={20} />
              ) : (
                <WifiOff className="text-red-500" size={20} />
              )}
              <span className="text-sm font-medium">
                {connected ? 'Conectado' : 'Desconectado'}
              </span>
            </div>
            <div className="flex items-center gap-2">
              <MapPin className={gpsActive ? 'text-green-500' : 'text-gray-400'} size={20} />
              <span className="text-sm font-medium">
                {gpsActive ? 'GPS Activo' : 'GPS Inactivo'}
              </span>
            </div>
          </div>

          <div className="text-center py-8">
            <div className="text-7xl font-bold text-indigo-600 mb-2">
              {speed}
            </div>
            <div className="text-2xl text-gray-600">km/h</div>
          </div>

          {error && (
            <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
              {error}
            </div>
          )}

          <div className="mt-6">
            {!gpsActive ? (
              <button
                onClick={startTracking}
                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
              >
                Iniciar Seguimiento
              </button>
            ) : (
              <button
                onClick={stopTracking}
                className="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
              >
                Detener Seguimiento
              </button>
            )}
          </div>
        </div>

        {/* Lista de usuarios conectados */}
        <div className="bg-white rounded-lg shadow-lg p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <Users size={24} className="text-indigo-600" />
            Usuarios Conectados ({users.length})
          </h2>
          
          {users.length === 0 ? (
            <p className="text-gray-500 text-center py-8">
              No hay usuarios conectados
            </p>
          ) : (
            <div className="space-y-3">
              {users.map((user) => (
                <div
                  key={user.userId}
                  className={`p-4 rounded-lg border-2 transition-all ${
                    user.userId === userId
                      ? 'bg-indigo-50 border-indigo-300'
                      : 'bg-gray-50 border-gray-200'
                  }`}
                >
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      <div className="font-mono text-xs text-gray-600 mb-1">
                        {user.userId}
                        {user.userId === userId && (
                          <span className="ml-2 text-indigo-600 font-semibold">(T칰)</span>
                        )}
                      </div>
                      <div className="text-sm text-gray-500">
                        칔ltima actualizaci칩n: {new Date(user.timestamp).toLocaleTimeString()}
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="text-3xl font-bold text-indigo-600">
                        {user.speed}
                      </div>
                      <div className="text-sm text-gray-600">km/h</div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Instrucciones */}
        <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
          <p className="font-semibold mb-2">游눠 Consejos:</p>
          <ul className="list-disc list-inside space-y-1">
            <li>Aseg칰rate de tener el GPS activado en tu dispositivo</li>
            <li>Permite el acceso a la ubicaci칩n cuando te lo solicite el navegador</li>
            <li>Para mejores resultados, 칰salo en exteriores con cielo despejado</li>
            <li>La velocidad se actualiza autom치ticamente cada segundo</li>
          </ul>
        </div>
      </div>
    </div>
  );
}
