<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GPS Tracker">
  <meta name="theme-color" content="#4F46E5">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR1BTIFNwZWVkIFRyYWNrZXIiLCJzaG9ydF9uYW1lIjoiR1BTIFRyYWNrZXIiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzRGNDZFNSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDY2lyY2xlIGN4PSc1MCcgY3k9JzUwJyByPSc0MCcgZmlsbD0nJTIzNEY0NkU1Jy8lM0UlM0N0ZXh0IHg9JzUwJyB5PSc2MCcgZm9udC1zaXplPSc0MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nd2hpdGUnJTNF8J+agCUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDY2lyY2xlIGN4PSc1MCcgY3k9JzUwJyByPSc0MCcgZmlsbD0nJTIzNEY0NkU1Jy8lM0UlM0N0ZXh0IHg9JzUwJyB5PSc2MCcgZm9udC1zaXplPSc0MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nd2hpdGUnJTNF8J+agCUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
  <title>GPS Speed Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      overscroll-behavior: contain;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }
    * {
      box-sizing: border-box;
    }
    @media (display-mode: standalone) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 m-0 p-0">
  <div id="app" class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">üöÄ GPS Speed Tracker</h1>
        <p class="text-gray-600">Telemetr√≠a de velocidad en tiempo real</p>
        <p class="text-xs text-gray-400 mt-2">v2.0 - Con nombres de usuario ‚úì</p>
      </div>

      <!-- Configuraci√≥n -->
      <div id="config-section" class="bg-white rounded-lg shadow-lg p-6 mb-4">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Tu Nombre
          </label>
          <input
            id="user-name"
            type="text"
            maxlength="20"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="Ej: Juan, Mar√≠a, Alex..."
          />
          <p class="text-xs text-gray-500 mt-1">As√≠ te ver√°n los dem√°s usuarios</p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            URL del Servidor WebSocket
          </label>
          <input
            id="server-url"
            type="text"
            value="wss://gps-tracker-server-production-5900.up.railway.app"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-2"
            placeholder="wss://tu-servidor.up.railway.app"
          />
          <p class="text-sm text-gray-500">
            ID: <span id="user-id" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded"></span>
          </p>
        </div>
      </div>

      <!-- Estado -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
          <div class="flex items-center gap-2">
            <span id="wifi-icon" class="text-2xl">üì°</span>
            <span id="connection-status" class="text-sm font-medium">Desconectado</span>
          </div>
          <div class="flex items-center gap-2">
            <span id="gps-icon" class="text-2xl">üìç</span>
            <span id="gps-status" class="text-sm font-medium">GPS Inactivo</span>
          </div>
        </div>

        <!-- Velocidad -->
        <div class="text-center py-8">
          <div id="speed-display" class="text-7xl font-bold text-indigo-600 mb-2">0</div>
          <div class="text-2xl text-gray-600">km/h</div>
        </div>

        <!-- Error -->
        <div id="error-box" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>

        <!-- Success -->
        <div id="success-box" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm"></div>

        <!-- Info adicional -->
        <div id="gps-info" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 text-sm">
          <p class="mb-1"><strong>Precisi√≥n GPS:</strong> <span id="accuracy">--</span> metros</p>
          <p class="mb-1"><strong>Coordenadas:</strong> <span id="coords" class="text-xs">--</span></p>
        </div>

        <!-- Bot√≥n -->
        <div class="mt-6">
          <button
            id="track-button"
            class="w-full bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
          >
            Iniciar Seguimiento
          </button>
        </div>
      </div>

      <!-- Usuarios -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <span class="text-2xl">üë•</span>
          Usuarios Conectados (<span id="user-count">0</span>)
        </h2>
        <div id="users-list" class="space-y-3">
          <p class="text-gray-500 text-center py-8">No hay usuarios conectados</p>
        </div>
      </div>

      <!-- Instrucciones -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800 mb-4">
        <p class="font-semibold mb-2">üí° Pasos para usar:</p>
        <ol class="list-decimal list-inside space-y-1">
          <li>Introduce tu nombre</li>
          <li>Activa el GPS en tu m√≥vil</li>
          <li>Configura la URL del servidor</li>
          <li>Presiona "Iniciar Seguimiento"</li>
          <li>Permite acceso a ubicaci√≥n cuando te lo pida</li>
          <li>Sal al exterior para mejor se√±al GPS</li>
        </ol>
      </div>
    </div>
  </div>

  <script>
    console.log('üöÄ GPS Tracker v2.0 iniciado');
    
    // Variables globales
    let userId = localStorage.getItem('userId') || `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('userId', userId);
    
    let userName = localStorage.getItem('userName') || '';
    let ws = null;
    let watchId = null;
    let isTracking = false;
    let users = [];

    // Elementos DOM
    const elements = {
      userId: document.getElementById('user-id'),
      userName: document.getElementById('user-name'),
      serverUrl: document.getElementById('server-url'),
      configSection: document.getElementById('config-section'),
      wifiIcon: document.getElementById('wifi-icon'),
      connectionStatus: document.getElementById('connection-status'),
      gpsIcon: document.getElementById('gps-icon'),
      gpsStatus: document.getElementById('gps-status'),
      speedDisplay: document.getElementById('speed-display'),
      errorBox: document.getElementById('error-box'),
      successBox: document.getElementById('success-box'),
      gpsInfo: document.getElementById('gps-info'),
      trackButton: document.getElementById('track-button'),
      userCount: document.getElementById('user-count'),
      usersList: document.getElementById('users-list'),
      accuracy: document.getElementById('accuracy'),
      coords: document.getElementById('coords')
    };

    // Inicializar
    elements.userId.textContent = userId.substring(0, 30);
    elements.userName.value = userName;

    // Guardar nombre cuando cambie
    elements.userName.addEventListener('input', (e) => {
      userName = e.target.value.trim();
      localStorage.setItem('userName', userName);
    });

    // Mostrar error
    function showError(message) {
      console.error('‚ùå', message);
      elements.errorBox.textContent = message;
      elements.errorBox.classList.remove('hidden');
      elements.successBox.classList.add('hidden');
      setTimeout(() => elements.errorBox.classList.add('hidden'), 8000);
    }

    // Mostrar √©xito
    function showSuccess(message) {
      console.log('‚úì', message);
      elements.successBox.textContent = message;
      elements.successBox.classList.remove('hidden');
      elements.errorBox.classList.add('hidden');
      setTimeout(() => elements.successBox.classList.add('hidden'), 3000);
    }

    // Actualizar estado de conexi√≥n
    function updateConnectionStatus(connected) {
      elements.wifiIcon.textContent = connected ? '‚úÖ' : '‚ùå';
      elements.connectionStatus.textContent = connected ? 'Conectado' : 'Desconectado';
      elements.connectionStatus.className = `text-sm font-medium ${connected ? 'text-green-600' : 'text-red-600'}`;
    }

    // Actualizar estado GPS
    function updateGpsStatus(active) {
      elements.gpsIcon.textContent = active ? '‚úÖ' : 'üìç';
      elements.gpsStatus.textContent = active ? 'GPS Activo' : 'GPS Inactivo';
      elements.gpsStatus.className = `text-sm font-medium ${active ? 'text-green-600' : 'text-gray-600'}`;
    }

    // Conectar WebSocket
    function connectWebSocket() {
      const serverUrl = elements.serverUrl.value;
      console.log('üîå Conectando a:', serverUrl);
      
      try {
        ws = new WebSocket(serverUrl);
        
        ws.onopen = () => {
          updateConnectionStatus(true);
          showSuccess('‚úì Conectado al servidor');
          ws.send(JSON.stringify({ 
            type: 'register', 
            userId,
            userName: userName || 'Usuario'
          }));
          console.log('‚úì Registrado en servidor');
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'users') {
            users = data.users;
            updateUsersList();
          }
        };

        ws.onerror = (error) => {
          console.error('‚ùå Error WebSocket:', error);
          showError('‚ö†Ô∏è Error de conexi√≥n. Verifica el servidor.');
          updateConnectionStatus(false);
        };

        ws.onclose = () => {
          console.log('üîå Conexi√≥n cerrada');
          updateConnectionStatus(false);
          if (isTracking) {
            console.log('‚Üª Reconectando...');
            setTimeout(connectWebSocket, 3000);
          }
        };
      } catch (error) {
        console.error('‚ùå Error al crear WebSocket:', error);
        showError('No se pudo conectar: ' + error.message);
      }
    }

    // Actualizar lista de usuarios
    function updateUsersList() {
      elements.userCount.textContent = users.length;
      
      if (users.length === 0) {
        elements.usersList.innerHTML = '<p class="text-gray-500 text-center py-8">No hay usuarios conectados</p>';
        return;
      }

      elements.usersList.innerHTML = users.map(user => {
        const displayName = user.userName || user.userId.substring(0, 15);
        const isCurrentUser = user.userId === userId;
        
        return `
        <div class="p-4 rounded-lg border-2 ${isCurrentUser ? 'bg-indigo-50 border-indigo-300' : 'bg-gray-50 border-gray-200'}">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-lg font-semibold text-gray-800">${displayName}</span>
                ${isCurrentUser ? '<span class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-full">T√∫</span>' : ''}
              </div>
              <div class="text-xs text-gray-500 font-mono truncate">
                ID: ${user.userId.substring(0, 20)}...
              </div>
              <div class="text-sm text-gray-500 mt-1">
                ${new Date(user.timestamp).toLocaleTimeString()}
              </div>
            </div>
            <div class="text-right ml-4">
              <div class="text-3xl font-bold text-indigo-600">${user.speed}</div>
              <div class="text-sm text-gray-600">km/h</div>
            </div>
          </div>
        </div>
      `}).join('');
    }

    // Iniciar seguimiento GPS
    function startTracking() {
      console.log('üéØ Iniciando seguimiento GPS...');
      
      // Validar nombre
      if (!userName || userName.trim() === '') {
        showError('‚ö†Ô∏è Por favor, introduce tu nombre antes de comenzar');
        elements.userName.focus();
        return;
      }
      
      if (!navigator.geolocation) {
        showError('‚ùå GPS no disponible en este dispositivo');
        return;
      }

      elements.configSection.classList.add('hidden');
      connectWebSocket();

      const options = {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      };

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const speed = position.coords.speed !== null 
            ? Math.max(0, Math.round(position.coords.speed * 3.6))
            : 0;
          
          elements.speedDisplay.textContent = speed;
          updateGpsStatus(true);
          elements.gpsInfo.classList.remove('hidden');
          
          const accuracy = Math.round(position.coords.accuracy);
          elements.accuracy.textContent = accuracy;
          elements.coords.textContent = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;

          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'speed',
              userId,
              userName: userName || 'Usuario',
              speed,
              lat: position.coords.latitude,
              lon: position.coords.longitude,
              timestamp: Date.now()
            }));
          }
        },
        (error) => {
          let errorMsg = '';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = '‚ùå Permisos denegados. Ve a Configuraci√≥n ‚Üí Permisos ‚Üí Ubicaci√≥n';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = '‚ö†Ô∏è GPS no disponible. Sal al exterior.';
              break;
            case error.TIMEOUT:
              errorMsg = '‚è±Ô∏è Tiempo agotado. Verifica que el GPS est√© activado.';
              break;
            default:
              errorMsg = '‚ùå Error GPS: ' + error.message;
          }
          showError(errorMsg);
          updateGpsStatus(false);
        },
        options
      );

      isTracking = true;
      elements.trackButton.textContent = 'Detener Seguimiento';
      elements.trackButton.className = 'w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-semibold py-3 px-6 rounded-lg transition-colors';
    }

    // Detener seguimiento
    function stopTracking() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      
      if (ws) {
        ws.close();
        ws = null;
      }
      
      isTracking = false;
      updateGpsStatus(false);
      updateConnectionStatus(false);
      elements.speedDisplay.textContent = '0';
      elements.gpsInfo.classList.add('hidden');
      elements.configSection.classList.remove('hidden');
      elements.trackButton.textContent = 'Iniciar Seguimiento';
      elements.trackButton.className = 'w-full bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-semibold py-3 px-6 rounded-lg transition-colors';
    }

    // Evento del bot√≥n
    elements.trackButton.addEventListener('click', () => {
      if (isTracking) {
        stopTracking();
      } else {
        startTracking();
      }
    });

    console.log('‚úì GPS Tracker listo');
  </script>
</body>
</html>
