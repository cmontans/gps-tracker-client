<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="3WB Tracker">
  <meta name="theme-color" content="#4F46E5">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiM1dCIFNwZWVkIFRyYWNrZXIiLCJzaG9ydF9uYW1lIjoiM1dCIFRyYWNrZXIiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzRGNDZFNSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDY2lyY2xlIGN4PSc1MCcgY3k9JzUwJyByPSc0MCcgZmlsbD0nJTIzNEY0NkU1Jy8lM0UlM0N0ZXh0IHg9JzUwJyB5PSc2MCcgZm9udC1zaXplPSc0MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nd2hpdGUnJTNF8J+agCUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDY2lyY2xlIGN4PSc1MCcgY3k9JzUwJyByPSc0MCcgZmlsbD0nJTIzNEY0NkU1Jy8lM0UlM0N0ZXh0IHg9JzUwJyB5PSc2MCcgZm9udC1zaXplPSc0MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nd2hpdGUnJTNF8J+agCUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
  <title>3WB Speed Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          screens: {
            'xs': '475px',
          }
        }
      }
    }
  </script>
  <style>
    body {
      overscroll-behavior: contain;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }
    * {
      box-sizing: border-box;
    }
    @media (display-mode: standalone) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 m-0 p-0 transition-colors">
  <div id="app" class="min-h-screen p-2 sm:p-4">
    <div class="max-w-7xl mx-auto">
      <!-- Header with Settings -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 sm:p-6 mb-4 transition-colors">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-white mb-2">ğŸš€ 3WB Speed Tracker</h1>
            <p class="text-sm sm:text-base text-gray-600 dark:text-gray-300">TelemetrÃ­a de velocidad en tiempo real</p>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">v4.1 - Modo oscuro, visualizador y pantalla completa âœ“</p>
          </div>
          <div class="flex gap-2">
            <button
              id="dark-mode-toggle"
              class="bg-gray-600 hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              ğŸŒ™
            </button>
            <button
              id="history-button"
              class="bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-600 text-white px-3 py-2 rounded-lg text-xl transition-colors"
            >
              ğŸ“Š
            </button>
            <button
              id="settings-button"
              class="bg-gray-600 hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-xl transition-colors"
            >
              âš™ï¸
            </button>
          </div>
        </div>
        <div id="wake-lock-status" class="hidden mt-2 text-xs">
          <span class="bg-green-100 text-green-800 px-2 py-1 rounded">ğŸ”’ Pantalla bloqueada</span>
        </div>
      </div>

      <!-- Settings Modal -->
      <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto transition-colors">
          <div class="sticky top-0 bg-white dark:bg-gray-800 border-b dark:border-gray-700 p-4 flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white">âš™ï¸ ConfiguraciÃ³n</h2>
            <button id="close-settings" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-2xl leading-none">
              âœ•
            </button>
          </div>
          <div class="p-4 space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                URL del Servidor WebSocket
              </label>
              <input
                id="server-url"
                type="text"
                value="wss://gps-tracker-server-production-5900.up.railway.app"
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm transition-colors"
                placeholder="wss://tu-servidor.up.railway.app"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" id="language-label">
                Idioma
              </label>
              <select
                id="language-select"
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm transition-colors"
              >
                <option value="es">EspaÃ±ol</option>
                <option value="en">English</option>
                <option value="fr">FranÃ§ais</option>
                <option value="de">Deutsch</option>
              </select>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <label for="auto-center-toggle" class="text-sm font-medium text-gray-700 dark:text-gray-300" id="auto-center-label">
                Auto-centrar mapa en mi ubicaciÃ³n
              </label>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="auto-center-toggle" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
              </label>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <label for="voice-enabled-toggle" class="text-sm font-medium text-gray-700 dark:text-gray-300" id="voice-enabled-label">
                ğŸ”Š Anunciar velocidad por voz
              </label>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="voice-enabled-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
              </label>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <label for="visualizer-mode-toggle" class="text-sm font-medium text-gray-700 dark:text-gray-300" id="visualizer-mode-label">
                ğŸ‘ï¸ Modo Visualizador (solo ver, no publicar)
              </label>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="visualizer-mode-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
              </label>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" id="min-speed-label">
                Velocidad mÃ­nima para anunciar (km/h)
              </label>
              <input
                id="min-speed-input"
                type="number"
                value="22"
                min="0"
                max="200"
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm transition-colors"
                placeholder="22"
              />
            </div>
            <div class="pt-4 border-t dark:border-gray-700">
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                ID: <span id="user-id" class="font-mono text-xs bg-gray-100 dark:bg-gray-700 dark:text-gray-300 px-2 py-1 rounded"></span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- History Modal -->
      <div id="history-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transition-colors">
          <div class="sticky top-0 bg-white dark:bg-gray-800 border-b dark:border-gray-700 p-4 flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white">ğŸ“Š Speed History</h2>
            <button id="close-history" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-2xl leading-none">
              âœ•
            </button>
          </div>

          <!-- Statistics Card -->
          <div class="p-4">
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-gray-700 dark:to-gray-600 rounded-lg p-4 mb-4">
              <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Statistics</h3>
              <div class="grid grid-cols-3 gap-4">
                <div class="text-center">
                  <p class="text-xs text-gray-600 dark:text-gray-400">Total Records</p>
                  <p id="history-total-records" class="text-2xl font-bold text-gray-800 dark:text-white">0</p>
                </div>
                <div class="text-center">
                  <p class="text-xs text-gray-600 dark:text-gray-400">Highest Speed</p>
                  <p id="history-highest-speed" class="text-2xl font-bold text-red-600 dark:text-red-400">0.0</p>
                  <p class="text-xs text-gray-600 dark:text-gray-400">km/h</p>
                </div>
                <div class="text-center">
                  <p class="text-xs text-gray-600 dark:text-gray-400">Average Max</p>
                  <p id="history-average-max" class="text-2xl font-bold text-green-600 dark:text-green-400">0.0</p>
                  <p class="text-xs text-gray-600 dark:text-gray-400">km/h</p>
                </div>
              </div>
            </div>

            <!-- History Records List -->
            <div>
              <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">History Records</h3>
              <div id="history-records-container" class="space-y-2 max-h-96 overflow-y-auto">
                <div id="history-loading" class="text-center text-gray-500 dark:text-gray-400 py-8">
                  Loading...
                </div>
                <div id="history-empty" class="hidden text-center text-gray-500 dark:text-gray-400 py-8">
                  No speed history records yet
                </div>
                <div id="history-records-list" class="space-y-2">
                  <!-- Records will be inserted here dynamically -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ConfiguraciÃ³n -->
      <div id="config-section" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 sm:p-6 mb-4 transition-colors">
        <div class="mb-4">
          <label id="your-name-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Tu Nombre
          </label>
          <input
            id="user-name"
            type="text"
            maxlength="20"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-colors"
            placeholder="Ej: Juan, MarÃ­a, Alex..."
          />
          <p id="name-helper" class="text-xs text-gray-500 dark:text-gray-400 mt-1">AsÃ­ te verÃ¡n los demÃ¡s usuarios</p>
        </div>

        <div class="mb-4">
          <label id="group-name-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            ğŸ” Nombre del Grupo
          </label>
          <input
            id="group-name"
            type="text"
            maxlength="30"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-colors"
            placeholder="Ej: Amigos, Carrera2024, Familia..."
          />
          <p id="group-helper" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Solo verÃ¡s usuarios de tu mismo grupo</p>
        </div>
        
        <div class="flex gap-2">
          <button
            id="track-button"
            class="flex-1 bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
          >
            â–¶ï¸ Iniciar Seguimiento
          </button>
        </div>
      </div>

      <!-- Estado y EstadÃ­sticas -->
      <div id="status-section" style="display: none;" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 sm:p-6 mb-4 transition-colors">
        <!-- ConexiÃ³n y GPS -->
        <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
          <div class="flex items-center gap-2">
            <span id="wifi-icon" class="text-xl sm:text-2xl">ğŸ“¡</span>
            <span id="connection-status" class="text-xs sm:text-sm font-medium">Desconectado</span>
          </div>
          <div id="gps-status-container" class="flex items-center gap-2">
            <span id="gps-icon" class="text-xl sm:text-2xl">ğŸ“</span>
            <span id="gps-status" class="text-xs sm:text-sm font-medium">GPS Inactivo</span>
          </div>
        </div>

        <!-- Visualizer Mode Indicator -->
        <div id="visualizer-mode-indicator" class="hidden mb-4 p-3 bg-orange-100 dark:bg-orange-900 border-l-4 border-orange-500 rounded">
          <div class="flex items-center">
            <span class="text-xl mr-2">ğŸ‘ï¸</span>
            <span class="text-sm font-bold text-orange-700 dark:text-orange-200" id="visualizer-mode-text">Modo Visualizador Activo</span>
          </div>
          <p class="text-xs text-orange-600 dark:text-orange-300 mt-1">Viendo tracks del grupo sin publicar tu ubicaciÃ³n</p>
        </div>

        <!-- Velocidad y EstadÃ­sticas -->
        <div class="text-center py-4 sm:py-8">
          <div class="mb-4">
            <div id="current-speed-label" class="text-sm text-gray-600 dark:text-gray-400 mb-1">Velocidad Actual</div>
            <div id="speed-display" class="text-5xl sm:text-7xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">0.0</div>
            <div class="text-xl sm:text-2xl text-gray-600 dark:text-gray-400">km/h</div>
          </div>

          <div class="grid grid-cols-2 gap-2 sm:gap-4 mt-6">
            <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900 dark:to-green-800 rounded-lg p-3 sm:p-4 transition-colors">
              <div id="max-session-label" class="text-xs text-green-600 dark:text-green-300 font-semibold mb-1">ğŸ† MÃXIMA SESIÃ“N</div>
              <div id="max-speed" class="text-2xl sm:text-3xl font-bold text-green-700 dark:text-green-200">0.0</div>
              <div class="text-xs sm:text-sm text-green-600 dark:text-green-300">km/h</div>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900 dark:to-blue-800 rounded-lg p-3 sm:p-4 transition-colors">
              <div id="average-label" class="text-xs text-blue-600 dark:text-blue-300 font-semibold mb-1">ğŸ“Š PROMEDIO</div>
              <div id="avg-speed" class="text-2xl sm:text-3xl font-bold text-blue-700 dark:text-blue-200">0.0</div>
              <div class="text-xs sm:text-sm text-blue-600 dark:text-blue-300">km/h</div>
            </div>
          </div>

          <div class="flex gap-2 mt-4">
            <button
              id="reset-stats-button"
              class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              ğŸ”„ Resetear EstadÃ­sticas
            </button>
            <button
              id="group-horn-button"
              class="flex-1 bg-red-600 hover:bg-red-700 active:bg-red-800 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors transform active:scale-95"
            >
              ğŸ“¢ Bocina Grupal
            </button>
          </div>
        </div>

        <!-- Mensajes -->
        <div id="error-box" class="hidden mt-4 p-3 bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-lg text-red-700 dark:text-red-200 text-sm transition-colors"></div>
        <div id="success-box" class="hidden mt-4 p-3 bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-lg text-green-700 dark:text-green-200 text-sm transition-colors"></div>

        <!-- Info GPS -->
        <div id="gps-info" class="hidden mt-4 p-3 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg text-blue-700 dark:text-blue-200 text-sm transition-colors">
          <p class="mb-1"><strong id="gps-accuracy-label">PrecisiÃ³n GPS:</strong> <span id="accuracy">--</span> <span id="meters-label">metros</span></p>
          <p class="mb-1"><strong id="coordinates-label">Coordenadas:</strong> <span id="coords" class="text-xs break-all">--</span></p>
        </div>

        <!-- BotÃ³n Detener -->
        <div class="mt-6">
          <button
            id="stop-button"
            class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-semibold py-3 px-6 rounded-lg transition-colors text-lg"
          >
            â¹ï¸ Detener seguimiento
          </button>
        </div>
      </div>

      <!-- Usuarios -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 sm:p-6 mb-4 transition-colors">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
          <h2 id="users-title" class="text-lg sm:text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
            <span class="text-xl sm:text-2xl">ğŸ‘¥</span>
            Usuarios (<span id="user-count">0</span>)
          </h2>
          <button
            id="toggle-map-button"
            class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
          >
            ğŸ—ºï¸ Ver Mapa
          </button>
        </div>
        <div id="users-list" class="space-y-3">
          <p id="no-users-message" class="text-gray-500 dark:text-gray-400 text-center py-8">No hay usuarios conectados</p>
        </div>
      </div>

      <!-- Mapa -->
      <div id="map-container" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 sm:p-6 mb-4 transition-colors">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
          <h2 id="map-title" class="text-lg sm:text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
            <span class="text-xl sm:text-2xl">ğŸ—ºï¸</span>
            Mapa en Tiempo Real
          </h2>
          <div class="flex flex-wrap gap-2 w-full sm:w-auto">
            <button
              id="fullscreen-button"
              class="flex-1 sm:flex-none bg-purple-600 hover:bg-purple-700 dark:bg-purple-700 dark:hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              â›¶ Pantalla Completa
            </button>
            <button
              id="clear-tracks-button"
              class="flex-1 sm:flex-none bg-orange-600 hover:bg-orange-700 dark:bg-orange-700 dark:hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              ğŸ—‘ï¸ Limpiar
            </button>
            <button
              id="close-map-button"
              class="flex-1 sm:flex-none bg-gray-600 hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              âœ• Cerrar
            </button>
          </div>
        </div>
        <div id="map" class="w-full h-64 sm:h-96 lg:h-[500px] rounded-lg border-2 border-gray-200 dark:border-gray-700"></div>
        <div class="mt-4 text-xs sm:text-sm text-gray-600 dark:text-gray-400">
          <p id="legend-label" class="font-semibold mb-2">Leyenda:</p>
          <div class="flex flex-wrap gap-3 sm:gap-4">
            <div class="flex items-center gap-2">
              <span class="text-xl sm:text-2xl">ğŸ“</span>
              <span id="your-position-label">Tu posiciÃ³n</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xl sm:text-2xl">ğŸ‘¤</span>
              <span id="other-users-label">Otros usuarios</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="inline-block w-4 h-1 bg-blue-500"></span>
              <span id="trajectory-label">Trayectoria</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Fullscreen Map -->
      <div id="map-fullscreen" class="hidden fixed inset-0 bg-white dark:bg-gray-900 z-50 transition-colors">
        <div class="h-full flex flex-col">
          <div class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 p-3 flex items-center justify-between">
            <h2 id="map-fullscreen-title" class="text-lg font-bold text-gray-800 dark:text-white">ğŸ—ºï¸ Mapa - Pantalla Completa</h2>
            <button
              id="exit-fullscreen-button"
              class="bg-gray-600 hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              âœ• Salir
            </button>
          </div>
          <div id="map-fullscreen-container" class="flex-1"></div>
        </div>
      </div>

      <!-- Instrucciones -->
      <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg p-4 text-sm text-blue-800 dark:text-blue-200 mb-4 transition-colors">
        <p class="font-semibold mb-2">ğŸ’¡ Pasos para usar:</p>
        <ol class="list-decimal list-inside space-y-1">
          <li>Introduce tu nombre</li>
          <li><strong>Introduce el nombre del grupo</strong> (debe ser igual para todos los participantes)</li>
          <li>Activa el GPS en tu mÃ³vil</li>
          <li>Presiona "Iniciar Seguimiento"</li>
          <li>Permite acceso a ubicaciÃ³n cuando te lo pida</li>
          <li>Sal al exterior para mejor seÃ±al GPS</li>
        </ol>
      </div>

      <!-- Info sobre grupos -->
      <div class="bg-purple-50 dark:bg-purple-900 border border-purple-200 dark:border-purple-700 rounded-lg p-4 text-sm text-purple-800 dark:text-purple-200 mb-4 transition-colors">
        <p class="font-semibold mb-2">ğŸ” Sistema de Grupos:</p>
        <ul class="list-disc list-inside space-y-1">
          <li>Solo verÃ¡s usuarios que estÃ©n en tu mismo grupo</li>
          <li>El nombre del grupo distingue mayÃºsculas/minÃºsculas</li>
          <li>Ejemplos: "Amigos", "Carrera2024", "Familia"</li>
          <li>Todos los participantes deben usar el <strong>mismo nombre exacto</strong></li>
        </ul>
      </div>

      <!-- Instrucciones pantalla encendida -->
      <div class="bg-amber-50 dark:bg-amber-900 border border-amber-200 dark:border-amber-700 rounded-lg p-4 text-sm text-amber-800 dark:text-amber-200 mb-4 transition-colors">
        <p class="font-semibold mb-2">âš ï¸ Importante para GPS continuo:</p>
        <ul class="list-disc list-inside space-y-1">
          <li><strong>Android:</strong> La app mantendrÃ¡ la pantalla encendida automÃ¡ticamente. Baja el brillo para ahorrar baterÃ­a.</li>
          <li><strong>iOS:</strong> Ve a Ajustes â†’ Pantalla â†’ Bloqueo automÃ¡tico â†’ "Nunca" mientras usas la app.</li>
          <li><strong>Instalar como app:</strong> Chrome/Safari â†’ MenÃº â†’ "AÃ±adir a pantalla de inicio" para mejor rendimiento.</li>
        </ul>
      </div>

      <!-- Instrucciones iOS -->
      <div id="ios-instructions" class="hidden bg-purple-50 dark:bg-purple-900 border border-purple-200 dark:border-purple-700 rounded-lg p-4 text-sm text-purple-800 dark:text-purple-200 mb-4 transition-colors">
        <p class="font-semibold mb-2">ğŸ Usuarios de iPhone/iPad:</p>
        <ol class="list-decimal list-inside space-y-1">
          <li>Abre esta pÃ¡gina en <strong>Safari</strong> (no Chrome)</li>
          <li>Toca el botÃ³n "Compartir" (cuadrado con flecha arriba)</li>
          <li>Selecciona "AÃ±adir a pantalla de inicio"</li>
          <li>Abre la app desde el icono en tu pantalla</li>
          <li>Ve a Ajustes â†’ Safari â†’ UbicaciÃ³n â†’ "Permitir"</li>
          <li>Ajustes â†’ Privacidad â†’ UbicaciÃ³n â†’ Safari â†’ "Mientras se usa"</li>
        </ol>
      </div>
    </div>
  </div>

  <script>
    console.log('ğŸš€ 3WB Tracker v2.1 iniciado');

    // ==================== TRANSLATIONS ====================
    const translations = {
      es: {
        // Header
        title: 'ğŸš€ 3WB Speed Tracker',
        subtitle: 'TelemetrÃ­a de velocidad en tiempo real',
        version: 'v4.1 - Modo oscuro, visualizador y pantalla completa âœ“',
        settings: 'âš™ï¸',
        screenLocked: 'ğŸ”’ Pantalla bloqueada',

        // Settings Modal
        configuration: 'âš™ï¸ ConfiguraciÃ³n',
        serverUrl: 'URL del Servidor WebSocket',
        serverPlaceholder: 'wss://tu-servidor.up.railway.app',
        language: 'Idioma',
        autoCenterMap: 'Auto-centrar mapa en mi ubicaciÃ³n',
        voiceEnabled: 'ğŸ”Š Anunciar velocidad por voz',
        visualizerMode: 'ğŸ‘ï¸ Modo Visualizador (solo ver, no publicar)',
        visualizerModeActive: 'ğŸ‘ï¸ Modo Visualizador Activo',
        minSpeedLabel: 'Velocidad mÃ­nima para anunciar (km/h)',

        // Config Section
        yourName: 'Tu Nombre',
        namePlaceholder: 'Ej: Juan, MarÃ­a, Alex...',
        nameHelper: 'AsÃ­ te verÃ¡n los demÃ¡s usuarios',
        groupName: 'ğŸ” Nombre del Grupo',
        groupPlaceholder: 'Ej: Amigos, Carrera2024, Familia...',
        groupHelper: 'Solo verÃ¡s usuarios de tu mismo grupo',
        startTracking: 'â–¶ï¸ Iniciar Seguimiento',

        // Status Section
        disconnected: 'Desconectado',
        connected: 'Conectado',
        gpsInactive: 'GPS Inactivo',
        gpsActive: 'GPS Activo',
        currentSpeed: 'Velocidad Actual',
        maxSession: 'ğŸ† MÃXIMA SESIÃ“N',
        average: 'ğŸ“Š PROMEDIO',
        resetStats: 'ğŸ”„ Resetear EstadÃ­sticas',
        groupHorn: 'ğŸ“¢ Bocina Grupal',
        gpsAccuracy: 'PrecisiÃ³n GPS:',
        coordinates: 'Coordenadas:',
        meters: 'metros',
        stopTracking: 'â¹ï¸ Detener seguimiento',

        // Users Section
        users: 'Usuarios',
        viewMap: 'ğŸ—ºï¸ Ver Mapa',
        noUsersConnected: 'No hay usuarios conectados',
        you: 'TÃº',

        // Map Section
        mapRealTime: 'Mapa en Tiempo Real',
        fullscreen: 'â›¶ Pantalla Completa',
        clean: 'ğŸ—‘ï¸ Limpiar',
        close: 'âœ• Cerrar',
        legend: 'Leyenda:',
        yourPosition: 'Tu posiciÃ³n',
        otherUsers: 'Otros usuarios',
        trajectory: 'Trayectoria',
        mapFullscreen: 'ğŸ—ºï¸ Mapa - Pantalla Completa',
        exit: 'âœ• Salir',

        // Instructions
        instructionsTitle: 'ğŸ’¡ Pasos para usar:',
        step1: 'Introduce tu nombre',
        step2: '<strong>Introduce el nombre del grupo</strong> (debe ser igual para todos los participantes)',
        step3: 'Activa el GPS en tu mÃ³vil',
        step4: 'Presiona "Iniciar Seguimiento"',
        step5: 'Permite acceso a ubicaciÃ³n cuando te lo pida',
        step6: 'Sal al exterior para mejor seÃ±al GPS',

        groupSystemTitle: 'ğŸ” Sistema de Grupos:',
        groupInfo1: 'Solo verÃ¡s usuarios que estÃ©n en tu mismo grupo',
        groupInfo2: 'El nombre del grupo distingue mayÃºsculas/minÃºsculas',
        groupInfo3: 'Ejemplos: "Amigos", "Carrera2024", "Familia"',
        groupInfo4: 'Todos los participantes deben usar el <strong>mismo nombre exacto</strong>',

        importantGpsTitle: 'âš ï¸ Importante para GPS continuo:',
        androidInfo: '<strong>Android:</strong> La app mantendrÃ¡ la pantalla encendida automÃ¡ticamente. Baja el brillo para ahorrar baterÃ­a.',
        iosInfo: '<strong>iOS:</strong> Ve a Ajustes â†’ Pantalla â†’ Bloqueo automÃ¡tico â†’ "Nunca" mientras usas la app.',
        installInfo: '<strong>Instalar como app:</strong> Chrome/Safari â†’ MenÃº â†’ "AÃ±adir a pantalla de inicio" para mejor rendimiento.',

        iosInstructionsTitle: 'ğŸ Usuarios de iPhone/iPad:',
        iosStep1: 'Abre esta pÃ¡gina en <strong>Safari</strong> (no Chrome)',
        iosStep2: 'Toca el botÃ³n "Compartir" (cuadrado con flecha arriba)',
        iosStep3: 'Selecciona "AÃ±adir a pantalla de inicio"',
        iosStep4: 'Abre la app desde el icono en tu pantalla',
        iosStep5: 'Ve a Ajustes â†’ Safari â†’ UbicaciÃ³n â†’ "Permitir"',
        iosStep6: 'Ajustes â†’ Privacidad â†’ UbicaciÃ³n â†’ Safari â†’ "Mientras se usa"',

        // Messages
        statsReset: 'âœ“ EstadÃ­sticas reseteadas',
        mustBeTracking: 'âš ï¸ Debes estar en seguimiento para usar la bocina grupal',
        noConnection: 'âš ï¸ No hay conexiÃ³n con el servidor',
        hornActivated: 'ğŸ“¢ Bocina activada para todo el grupo!',
        hornReceived: 'ğŸ“¢ Â¡{name} ha activado la bocina grupal!',
        connectedToServer: 'âœ“ Conectado al servidor',
        tracksCleaned: 'âœ“ Trayectorias limpiadas',
        screenLockedMsg: 'âœ“ Pantalla bloqueada - No se apagarÃ¡',
        connectionError: 'âš ï¸ Error de conexiÃ³n. Verifica el servidor.',
        reconnectError: 'âŒ No se pudo reconectar despuÃ©s de mÃºltiples intentos',
        enterName: 'âš ï¸ Por favor, introduce tu nombre antes de comenzar',
        gpsNotAvailable: 'âŒ GPS no disponible en este dispositivo',
        permissionDenied: 'âŒ Permisos denegados. Ve a ConfiguraciÃ³n â†’ Permisos â†’ UbicaciÃ³n',
        positionUnavailable: 'âš ï¸ GPS no disponible. Sal al exterior.',
        timeout: 'â±ï¸ Tiempo agotado. Verifica que el GPS estÃ© activado.',
        gpsError: 'âŒ Error GPS: ',
        iosWakeLockError: 'iOS: Configura "Bloqueo automÃ¡tico: Nunca" en Ajustes',
        iosScreenError: 'En iOS: Ve a Ajustes â†’ Pantalla â†’ Bloqueo automÃ¡tico â†’ "Nunca"'
      },
      en: {
        // Header
        title: 'ğŸš€ 3WB Speed Tracker',
        subtitle: 'Real-time speed telemetry',
        version: 'v4.1 - Dark mode, viewer and fullscreen âœ“',
        settings: 'âš™ï¸',
        screenLocked: 'ğŸ”’ Screen locked',

        // Settings Modal
        configuration: 'âš™ï¸ Configuration',
        serverUrl: 'WebSocket Server URL',
        serverPlaceholder: 'wss://your-server.up.railway.app',
        language: 'Language',
        autoCenterMap: 'Auto-center map on my location',
        voiceEnabled: 'ğŸ”Š Announce speed by voice',
        visualizerMode: 'ğŸ‘ï¸ Visualizer Mode (view only, don\'t publish)',
        visualizerModeActive: 'ğŸ‘ï¸ Visualizer Mode Active',
        minSpeedLabel: 'Minimum speed to announce (km/h)',

        // Config Section
        yourName: 'Your Name',
        namePlaceholder: 'E.g: John, Mary, Alex...',
        nameHelper: 'This is how others will see you',
        groupName: 'ğŸ” Group Name',
        groupPlaceholder: 'E.g: Friends, Race2024, Family...',
        groupHelper: 'You will only see users in your same group',
        startTracking: 'â–¶ï¸ Start Tracking',

        // Status Section
        disconnected: 'Disconnected',
        connected: 'Connected',
        gpsInactive: 'GPS Inactive',
        gpsActive: 'GPS Active',
        currentSpeed: 'Current Speed',
        maxSession: 'ğŸ† SESSION MAX',
        average: 'ğŸ“Š AVERAGE',
        resetStats: 'ğŸ”„ Reset Statistics',
        groupHorn: 'ğŸ“¢ Group Horn',
        gpsAccuracy: 'GPS Accuracy:',
        coordinates: 'Coordinates:',
        meters: 'meters',
        stopTracking: 'â¹ï¸ Stop tracking',

        // Users Section
        users: 'Users',
        viewMap: 'ğŸ—ºï¸ View Map',
        noUsersConnected: 'No users connected',
        you: 'You',

        // Map Section
        mapRealTime: 'Real-Time Map',
        fullscreen: 'â›¶ Fullscreen',
        clean: 'ğŸ—‘ï¸ Clear',
        close: 'âœ• Close',
        legend: 'Legend:',
        yourPosition: 'Your position',
        otherUsers: 'Other users',
        trajectory: 'Trajectory',
        mapFullscreen: 'ğŸ—ºï¸ Map - Fullscreen',
        exit: 'âœ• Exit',

        // Instructions
        instructionsTitle: 'ğŸ’¡ Steps to use:',
        step1: 'Enter your name',
        step2: '<strong>Enter the group name</strong> (must be the same for all participants)',
        step3: 'Activate GPS on your mobile',
        step4: 'Press "Start Tracking"',
        step5: 'Allow location access when prompted',
        step6: 'Go outside for better GPS signal',

        groupSystemTitle: 'ğŸ” Group System:',
        groupInfo1: 'You will only see users in your same group',
        groupInfo2: 'Group name is case-sensitive',
        groupInfo3: 'Examples: "Friends", "Race2024", "Family"',
        groupInfo4: 'All participants must use the <strong>exact same name</strong>',

        importantGpsTitle: 'âš ï¸ Important for continuous GPS:',
        androidInfo: '<strong>Android:</strong> The app will keep the screen on automatically. Lower brightness to save battery.',
        iosInfo: '<strong>iOS:</strong> Go to Settings â†’ Display â†’ Auto-Lock â†’ "Never" while using the app.',
        installInfo: '<strong>Install as app:</strong> Chrome/Safari â†’ Menu â†’ "Add to home screen" for better performance.',

        iosInstructionsTitle: 'ğŸ iPhone/iPad Users:',
        iosStep1: 'Open this page in <strong>Safari</strong> (not Chrome)',
        iosStep2: 'Tap the "Share" button (square with arrow up)',
        iosStep3: 'Select "Add to Home Screen"',
        iosStep4: 'Open the app from the icon on your screen',
        iosStep5: 'Go to Settings â†’ Safari â†’ Location â†’ "Allow"',
        iosStep6: 'Settings â†’ Privacy â†’ Location â†’ Safari â†’ "While Using"',

        // Messages
        statsReset: 'âœ“ Statistics reset',
        mustBeTracking: 'âš ï¸ You must be tracking to use the group horn',
        noConnection: 'âš ï¸ No connection to server',
        hornActivated: 'ğŸ“¢ Horn activated for the entire group!',
        hornReceived: 'ğŸ“¢ {name} has activated the group horn!',
        connectedToServer: 'âœ“ Connected to server',
        tracksCleaned: 'âœ“ Trajectories cleared',
        screenLockedMsg: 'âœ“ Screen locked - Won\'t turn off',
        connectionError: 'âš ï¸ Connection error. Check the server.',
        reconnectError: 'âŒ Could not reconnect after multiple attempts',
        enterName: 'âš ï¸ Please enter your name before starting',
        gpsNotAvailable: 'âŒ GPS not available on this device',
        permissionDenied: 'âŒ Permission denied. Go to Settings â†’ Permissions â†’ Location',
        positionUnavailable: 'âš ï¸ GPS unavailable. Go outside.',
        timeout: 'â±ï¸ Timeout. Verify that GPS is activated.',
        gpsError: 'âŒ GPS Error: ',
        iosWakeLockError: 'iOS: Configure "Auto-Lock: Never" in Settings',
        iosScreenError: 'On iOS: Go to Settings â†’ Display â†’ Auto-Lock â†’ "Never"'
      },
      fr: {
        // Header
        title: 'ğŸš€ 3WB Speed Tracker',
        subtitle: 'TÃ©lÃ©mÃ©trie de vitesse en temps rÃ©el',
        version: 'v4.1 - Mode sombre, visualiseur et plein Ã©cran âœ“',
        settings: 'âš™ï¸',
        screenLocked: 'ğŸ”’ Ã‰cran verrouillÃ©',

        // Settings Modal
        configuration: 'âš™ï¸ Configuration',
        serverUrl: 'URL du serveur WebSocket',
        serverPlaceholder: 'wss://votre-serveur.up.railway.app',
        language: 'Langue',
        autoCenterMap: 'Centrer automatiquement la carte sur ma position',
        voiceEnabled: 'ğŸ”Š Annoncer la vitesse par voix',
        visualizerMode: 'ğŸ‘ï¸ Mode Visualiseur (voir uniquement, ne pas publier)',
        visualizerModeActive: 'ğŸ‘ï¸ Mode Visualiseur Actif',
        minSpeedLabel: 'Vitesse minimale pour annoncer (km/h)',

        // Config Section
        yourName: 'Votre Nom',
        namePlaceholder: 'Ex: Jean, Marie, Alex...',
        nameHelper: 'C\'est ainsi que les autres vous verront',
        groupName: 'ğŸ” Nom du Groupe',
        groupPlaceholder: 'Ex: Amis, Course2024, Famille...',
        groupHelper: 'Vous ne verrez que les utilisateurs de votre groupe',
        startTracking: 'â–¶ï¸ DÃ©marrer le Suivi',

        // Status Section
        disconnected: 'DÃ©connectÃ©',
        connected: 'ConnectÃ©',
        gpsInactive: 'GPS Inactif',
        gpsActive: 'GPS Actif',
        currentSpeed: 'Vitesse Actuelle',
        maxSession: 'ğŸ† MAX SESSION',
        average: 'ğŸ“Š MOYENNE',
        resetStats: 'ğŸ”„ RÃ©initialiser les Statistiques',
        groupHorn: 'ğŸ“¢ Klaxon de Groupe',
        gpsAccuracy: 'PrÃ©cision GPS:',
        coordinates: 'CoordonnÃ©es:',
        meters: 'mÃ¨tres',
        stopTracking: 'â¹ï¸ ArrÃªter le suivi',

        // Users Section
        users: 'Utilisateurs',
        viewMap: 'ğŸ—ºï¸ Voir la Carte',
        noUsersConnected: 'Aucun utilisateur connectÃ©',
        you: 'Vous',

        // Map Section
        mapRealTime: 'Carte en Temps RÃ©el',
        fullscreen: 'â›¶ Plein Ã‰cran',
        clean: 'ğŸ—‘ï¸ Effacer',
        close: 'âœ• Fermer',
        legend: 'LÃ©gende:',
        yourPosition: 'Votre position',
        otherUsers: 'Autres utilisateurs',
        trajectory: 'Trajectoire',
        mapFullscreen: 'ğŸ—ºï¸ Carte - Plein Ã‰cran',
        exit: 'âœ• Sortir',

        // Instructions
        instructionsTitle: 'ğŸ’¡ Ã‰tapes d\'utilisation:',
        step1: 'Entrez votre nom',
        step2: '<strong>Entrez le nom du groupe</strong> (doit Ãªtre identique pour tous les participants)',
        step3: 'Activez le GPS sur votre mobile',
        step4: 'Appuyez sur "DÃ©marrer le Suivi"',
        step5: 'Autorisez l\'accÃ¨s Ã  la localisation lorsqu\'on vous le demande',
        step6: 'Sortez Ã  l\'extÃ©rieur pour un meilleur signal GPS',

        groupSystemTitle: 'ğŸ” SystÃ¨me de Groupes:',
        groupInfo1: 'Vous ne verrez que les utilisateurs de votre groupe',
        groupInfo2: 'Le nom du groupe est sensible Ã  la casse',
        groupInfo3: 'Exemples: "Amis", "Course2024", "Famille"',
        groupInfo4: 'Tous les participants doivent utiliser le <strong>mÃªme nom exact</strong>',

        importantGpsTitle: 'âš ï¸ Important pour le GPS continu:',
        androidInfo: '<strong>Android:</strong> L\'application maintiendra l\'Ã©cran allumÃ© automatiquement. Baissez la luminositÃ© pour Ã©conomiser la batterie.',
        iosInfo: '<strong>iOS:</strong> Allez dans RÃ©glages â†’ Affichage â†’ Verrouillage auto â†’ "Jamais" pendant l\'utilisation de l\'app.',
        installInfo: '<strong>Installer comme app:</strong> Chrome/Safari â†’ Menu â†’ "Ajouter Ã  l\'Ã©cran d\'accueil" pour de meilleures performances.',

        iosInstructionsTitle: 'ğŸ Utilisateurs iPhone/iPad:',
        iosStep1: 'Ouvrez cette page dans <strong>Safari</strong> (pas Chrome)',
        iosStep2: 'Appuyez sur le bouton "Partager" (carrÃ© avec flÃ¨che vers le haut)',
        iosStep3: 'SÃ©lectionnez "Sur l\'Ã©cran d\'accueil"',
        iosStep4: 'Ouvrez l\'app depuis l\'icÃ´ne sur votre Ã©cran',
        iosStep5: 'Allez dans RÃ©glages â†’ Safari â†’ Localisation â†’ "Autoriser"',
        iosStep6: 'RÃ©glages â†’ ConfidentialitÃ© â†’ Localisation â†’ Safari â†’ "Lorsque l\'app est active"',

        // Messages
        statsReset: 'âœ“ Statistiques rÃ©initialisÃ©es',
        mustBeTracking: 'âš ï¸ Vous devez Ãªtre en suivi pour utiliser le klaxon de groupe',
        noConnection: 'âš ï¸ Pas de connexion au serveur',
        hornActivated: 'ğŸ“¢ Klaxon activÃ© pour tout le groupe!',
        hornReceived: 'ğŸ“¢ {name} a activÃ© le klaxon de groupe!',
        connectedToServer: 'âœ“ ConnectÃ© au serveur',
        tracksCleaned: 'âœ“ Trajectoires effacÃ©es',
        screenLockedMsg: 'âœ“ Ã‰cran verrouillÃ© - Ne s\'Ã©teindra pas',
        connectionError: 'âš ï¸ Erreur de connexion. VÃ©rifiez le serveur.',
        reconnectError: 'âŒ Impossible de se reconnecter aprÃ¨s plusieurs tentatives',
        enterName: 'âš ï¸ Veuillez entrer votre nom avant de commencer',
        gpsNotAvailable: 'âŒ GPS non disponible sur cet appareil',
        permissionDenied: 'âŒ Permission refusÃ©e. Allez dans RÃ©glages â†’ Autorisations â†’ Localisation',
        positionUnavailable: 'âš ï¸ GPS non disponible. Sortez Ã  l\'extÃ©rieur.',
        timeout: 'â±ï¸ DÃ©lai expirÃ©. VÃ©rifiez que le GPS est activÃ©.',
        gpsError: 'âŒ Erreur GPS: ',
        iosWakeLockError: 'iOS: Configurez "Verrouillage auto: Jamais" dans RÃ©glages',
        iosScreenError: 'Sur iOS: Allez dans RÃ©glages â†’ Affichage â†’ Verrouillage auto â†’ "Jamais"'
      },
      de: {
        // Header
        title: 'ğŸš€ 3WB Speed Tracker',
        subtitle: 'Echtzeit-Geschwindigkeitstelemetrie',
        version: 'v4.1 - Dunkelmodus, Viewer und Vollbild âœ“',
        settings: 'âš™ï¸',
        screenLocked: 'ğŸ”’ Bildschirm gesperrt',

        // Settings Modal
        configuration: 'âš™ï¸ Konfiguration',
        serverUrl: 'WebSocket-Server-URL',
        serverPlaceholder: 'wss://ihr-server.up.railway.app',
        language: 'Sprache',
        autoCenterMap: 'Karte automatisch auf meinen Standort zentrieren',
        voiceEnabled: 'ğŸ”Š Geschwindigkeit per Sprache ankÃ¼ndigen',
        visualizerMode: 'ğŸ‘ï¸ Visualisierungsmodus (nur ansehen, nicht verÃ¶ffentlichen)',
        visualizerModeActive: 'ğŸ‘ï¸ Visualisierungsmodus Aktiv',
        minSpeedLabel: 'Mindestgeschwindigkeit zum AnkÃ¼ndigen (km/h)',

        // Config Section
        yourName: 'Ihr Name',
        namePlaceholder: 'Z.B: Hans, Maria, Alex...',
        nameHelper: 'So werden andere Sie sehen',
        groupName: 'ğŸ” Gruppenname',
        groupPlaceholder: 'Z.B: Freunde, Rennen2024, Familie...',
        groupHelper: 'Sie sehen nur Benutzer in Ihrer Gruppe',
        startTracking: 'â–¶ï¸ Tracking Starten',

        // Status Section
        disconnected: 'Getrennt',
        connected: 'Verbunden',
        gpsInactive: 'GPS Inaktiv',
        gpsActive: 'GPS Aktiv',
        currentSpeed: 'Aktuelle Geschwindigkeit',
        maxSession: 'ğŸ† SESSION MAX',
        average: 'ğŸ“Š DURCHSCHNITT',
        resetStats: 'ğŸ”„ Statistiken ZurÃ¼cksetzen',
        groupHorn: 'ğŸ“¢ Gruppen-Hupe',
        gpsAccuracy: 'GPS-Genauigkeit:',
        coordinates: 'Koordinaten:',
        meters: 'Meter',
        stopTracking: 'â¹ï¸ Tracking stoppen',

        // Users Section
        users: 'Benutzer',
        viewMap: 'ğŸ—ºï¸ Karte Anzeigen',
        noUsersConnected: 'Keine Benutzer verbunden',
        you: 'Sie',

        // Map Section
        mapRealTime: 'Echtzeit-Karte',
        fullscreen: 'â›¶ Vollbild',
        clean: 'ğŸ—‘ï¸ LÃ¶schen',
        close: 'âœ• SchlieÃŸen',
        legend: 'Legende:',
        yourPosition: 'Ihre Position',
        otherUsers: 'Andere Benutzer',
        trajectory: 'Trajektorie',
        mapFullscreen: 'ğŸ—ºï¸ Karte - Vollbild',
        exit: 'âœ• Beenden',

        // Instructions
        instructionsTitle: 'ğŸ’¡ Schritte zur Verwendung:',
        step1: 'Geben Sie Ihren Namen ein',
        step2: '<strong>Geben Sie den Gruppennamen ein</strong> (muss fÃ¼r alle Teilnehmer gleich sein)',
        step3: 'Aktivieren Sie GPS auf Ihrem Handy',
        step4: 'DrÃ¼cken Sie "Tracking Starten"',
        step5: 'Erlauben Sie den Standortzugriff, wenn Sie dazu aufgefordert werden',
        step6: 'Gehen Sie nach drauÃŸen fÃ¼r ein besseres GPS-Signal',

        groupSystemTitle: 'ğŸ” Gruppensystem:',
        groupInfo1: 'Sie sehen nur Benutzer in Ihrer Gruppe',
        groupInfo2: 'Beim Gruppennamen wird GroÃŸ-/Kleinschreibung beachtet',
        groupInfo3: 'Beispiele: "Freunde", "Rennen2024", "Familie"',
        groupInfo4: 'Alle Teilnehmer mÃ¼ssen den <strong>exakt gleichen Namen</strong> verwenden',

        importantGpsTitle: 'âš ï¸ Wichtig fÃ¼r kontinuierliches GPS:',
        androidInfo: '<strong>Android:</strong> Die App hÃ¤lt den Bildschirm automatisch an. Reduzieren Sie die Helligkeit, um Batterie zu sparen.',
        iosInfo: '<strong>iOS:</strong> Gehen Sie zu Einstellungen â†’ Anzeige â†’ Automatische Sperre â†’ "Nie" wÃ¤hrend der App-Nutzung.',
        installInfo: '<strong>Als App installieren:</strong> Chrome/Safari â†’ MenÃ¼ â†’ "Zum Startbildschirm hinzufÃ¼gen" fÃ¼r bessere Leistung.',

        iosInstructionsTitle: 'ğŸ iPhone/iPad-Benutzer:',
        iosStep1: 'Ã–ffnen Sie diese Seite in <strong>Safari</strong> (nicht Chrome)',
        iosStep2: 'Tippen Sie auf die SchaltflÃ¤che "Teilen" (Quadrat mit Pfeil nach oben)',
        iosStep3: 'WÃ¤hlen Sie "Zum Home-Bildschirm"',
        iosStep4: 'Ã–ffnen Sie die App Ã¼ber das Symbol auf Ihrem Bildschirm',
        iosStep5: 'Gehen Sie zu Einstellungen â†’ Safari â†’ Standort â†’ "Erlauben"',
        iosStep6: 'Einstellungen â†’ Datenschutz â†’ Standort â†’ Safari â†’ "Beim Verwenden"',

        // Messages
        statsReset: 'âœ“ Statistiken zurÃ¼ckgesetzt',
        mustBeTracking: 'âš ï¸ Sie mÃ¼ssen tracken, um die Gruppen-Hupe zu verwenden',
        noConnection: 'âš ï¸ Keine Verbindung zum Server',
        hornActivated: 'ğŸ“¢ Hupe fÃ¼r die ganze Gruppe aktiviert!',
        hornReceived: 'ğŸ“¢ {name} hat die Gruppen-Hupe aktiviert!',
        connectedToServer: 'âœ“ Mit Server verbunden',
        tracksCleaned: 'âœ“ Trajektorien gelÃ¶scht',
        screenLockedMsg: 'âœ“ Bildschirm gesperrt - Schaltet sich nicht aus',
        connectionError: 'âš ï¸ Verbindungsfehler. ÃœberprÃ¼fen Sie den Server.',
        reconnectError: 'âŒ Konnte nach mehreren Versuchen nicht wieder verbinden',
        enterName: 'âš ï¸ Bitte geben Sie Ihren Namen ein, bevor Sie beginnen',
        gpsNotAvailable: 'âŒ GPS auf diesem GerÃ¤t nicht verfÃ¼gbar',
        permissionDenied: 'âŒ Berechtigung verweigert. Gehen Sie zu Einstellungen â†’ Berechtigungen â†’ Standort',
        positionUnavailable: 'âš ï¸ GPS nicht verfÃ¼gbar. Gehen Sie nach drauÃŸen.',
        timeout: 'â±ï¸ ZeitÃ¼berschreitung. ÃœberprÃ¼fen Sie, ob GPS aktiviert ist.',
        gpsError: 'âŒ GPS-Fehler: ',
        iosWakeLockError: 'iOS: Konfigurieren Sie "Automatische Sperre: Nie" in Einstellungen',
        iosScreenError: 'Auf iOS: Gehen Sie zu Einstellungen â†’ Anzeige â†’ Automatische Sperre â†’ "Nie"'
      }
    };

    // Current language (default: Spanish)
    let currentLanguage = localStorage.getItem('language') || 'es';

    // Translation helper function
    function t(key) {
      return translations[currentLanguage]?.[key] || translations['es'][key] || key;
    }

    // Function to update all UI text
    function updateUILanguage() {
      // Update HTML lang attribute
      document.documentElement.lang = currentLanguage;

      // Update all translatable elements
      document.querySelector('h1').innerHTML = t('title');
      document.querySelectorAll('p.text-sm.sm\\:text-base')[0].textContent = t('subtitle');
      document.querySelectorAll('p.text-xs.text-gray-400')[0].textContent = t('version');
      document.getElementById('settings-button').innerHTML = t('settings');

      // Wake lock status
      const wakeLockSpan = document.querySelector('#wake-lock-status span');
      if (wakeLockSpan) {
        wakeLockSpan.textContent = t('screenLocked');
      }

      // Settings modal
      document.querySelector('#settings-modal h2').innerHTML = t('configuration');
      document.querySelectorAll('#settings-modal label')[0].textContent = t('serverUrl');
      document.getElementById('server-url').placeholder = t('serverPlaceholder');
      elements.languageLabel.textContent = t('language');
      document.getElementById('auto-center-label').textContent = t('autoCenterMap');
      document.getElementById('voice-enabled-label').textContent = t('voiceEnabled');
      document.getElementById('visualizer-mode-label').textContent = t('visualizerMode');
      document.getElementById('min-speed-label').textContent = t('minSpeedLabel');

      // Config section
      document.getElementById('your-name-label').textContent = t('yourName');
      document.getElementById('user-name').placeholder = t('namePlaceholder');
      document.getElementById('name-helper').textContent = t('nameHelper');
      document.getElementById('group-name-label').innerHTML = t('groupName');
      document.getElementById('group-name').placeholder = t('groupPlaceholder');
      document.getElementById('group-helper').textContent = t('groupHelper');

      // Track button
      if (!isTracking) {
        elements.trackButton.textContent = t('startTracking');
      }

      // Status section
      if (elements.connectionStatus.textContent === 'Conectado' || elements.connectionStatus.textContent === 'Connected' ||
          elements.connectionStatus.textContent === 'ConnectÃ©' || elements.connectionStatus.textContent === 'Verbunden') {
        elements.connectionStatus.textContent = t('connected');
      } else {
        elements.connectionStatus.textContent = t('disconnected');
      }

      if (elements.gpsStatus.textContent.includes('Activ') || elements.gpsStatus.textContent.includes('Aktiv')) {
        elements.gpsStatus.textContent = t('gpsActive');
      } else {
        elements.gpsStatus.textContent = t('gpsInactive');
      }

      document.getElementById('current-speed-label').textContent = t('currentSpeed');
      document.getElementById('max-session-label').textContent = t('maxSession');
      document.getElementById('average-label').textContent = t('average');
      document.getElementById('reset-stats-button').innerHTML = t('resetStats');
      document.getElementById('group-horn-button').innerHTML = t('groupHorn');
      document.getElementById('stop-button').innerHTML = t('stopTracking');

      // GPS Info
      const gpsAccuracyLabel = document.getElementById('gps-accuracy-label');
      const coordinatesLabel = document.getElementById('coordinates-label');
      const metersLabel = document.getElementById('meters-label');
      if (gpsAccuracyLabel) gpsAccuracyLabel.textContent = t('gpsAccuracy');
      if (coordinatesLabel) coordinatesLabel.textContent = t('coordinates');
      if (metersLabel) metersLabel.textContent = t('meters');

      // Users section
      const usersTitle = document.getElementById('users-title');
      if (usersTitle) {
        const count = document.getElementById('user-count').textContent;
        usersTitle.innerHTML = `<span class="text-xl sm:text-2xl">ğŸ‘¥</span> ${t('users')} (<span id="user-count">${count}</span>)`;
      }
      const noUsersMsg = document.getElementById('no-users-message');
      if (noUsersMsg) {
        noUsersMsg.textContent = t('noUsersConnected');
      }
      document.getElementById('toggle-map-button').innerHTML = t('viewMap');

      // Map section
      const mapTitle = document.getElementById('map-title');
      if (mapTitle) {
        mapTitle.innerHTML = `<span class="text-xl sm:text-2xl">ğŸ—ºï¸</span> ${t('mapRealTime')}`;
      }
      const mapFullscreenTitle = document.getElementById('map-fullscreen-title');
      if (mapFullscreenTitle) {
        mapFullscreenTitle.textContent = `ğŸ—ºï¸ ${t('mapFullscreen')}`;
      }
      document.getElementById('fullscreen-button').innerHTML = t('fullscreen');
      document.getElementById('clear-tracks-button').innerHTML = t('clean');
      document.getElementById('close-map-button').innerHTML = t('close');
      document.getElementById('exit-fullscreen-button').innerHTML = t('exit');

      // Map legend
      const legendLabel = document.getElementById('legend-label');
      const yourPositionLabel = document.getElementById('your-position-label');
      const otherUsersLabel = document.getElementById('other-users-label');
      const trajectoryLabel = document.getElementById('trajectory-label');
      if (legendLabel) legendLabel.textContent = t('legend');
      if (yourPositionLabel) yourPositionLabel.textContent = t('yourPosition');
      if (otherUsersLabel) otherUsersLabel.textContent = t('otherUsers');
      if (trajectoryLabel) trajectoryLabel.textContent = t('trajectory');

      // Instructions
      const instructionsTitle = document.querySelector('.bg-blue-50 p.font-semibold');
      if (instructionsTitle) {
        instructionsTitle.textContent = t('instructionsTitle');
      }

      const instructionsList = document.querySelectorAll('.bg-blue-50 ol li');
      if (instructionsList.length >= 6) {
        instructionsList[0].textContent = t('step1');
        instructionsList[1].innerHTML = t('step2');
        instructionsList[2].textContent = t('step3');
        instructionsList[3].textContent = t('step4');
        instructionsList[4].textContent = t('step5');
        instructionsList[5].textContent = t('step6');
      }

      // Group system
      const groupTitle = document.querySelector('.bg-purple-50 p.font-semibold');
      if (groupTitle) {
        groupTitle.textContent = t('groupSystemTitle');
      }

      const groupList = document.querySelectorAll('.bg-purple-50 ul li');
      if (groupList.length >= 4) {
        groupList[0].textContent = t('groupInfo1');
        groupList[1].textContent = t('groupInfo2');
        groupList[2].textContent = t('groupInfo3');
        groupList[3].innerHTML = t('groupInfo4');
      }

      // Important GPS info
      const gpsTitle = document.querySelector('.bg-amber-50 p.font-semibold');
      if (gpsTitle) {
        gpsTitle.textContent = t('importantGpsTitle');
      }

      const gpsList = document.querySelectorAll('.bg-amber-50 ul li');
      if (gpsList.length >= 3) {
        gpsList[0].innerHTML = t('androidInfo');
        gpsList[1].innerHTML = t('iosInfo');
        gpsList[2].innerHTML = t('installInfo');
      }

      // iOS instructions
      const iosTitle = document.querySelector('#ios-instructions p.font-semibold');
      if (iosTitle) {
        iosTitle.textContent = t('iosInstructionsTitle');
      }

      const iosList = document.querySelectorAll('#ios-instructions ol li');
      if (iosList.length >= 6) {
        iosList[0].innerHTML = t('iosStep1');
        iosList[1].innerHTML = t('iosStep2');
        iosList[2].innerHTML = t('iosStep3');
        iosList[3].innerHTML = t('iosStep4');
        iosList[4].innerHTML = t('iosStep5');
        iosList[5].innerHTML = t('iosStep6');
      }

      console.log('âœ“ UI language updated to:', currentLanguage);
    }

    // Dark Mode Management
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const html = document.documentElement;

    // FunciÃ³n para actualizar el icono del botÃ³n
    function updateDarkModeIcon(isDark) {
      darkModeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    // Inicializar el modo oscuro desde localStorage (por defecto: modo oscuro)
    function initDarkMode() {
      const savedTheme = localStorage.getItem('theme');

      // Si no hay preferencia guardada, usar modo oscuro por defecto
      if (!savedTheme) {
        html.classList.add('dark');
        updateDarkModeIcon(true);
        localStorage.setItem('theme', 'dark');
      } else if (savedTheme === 'dark') {
        html.classList.add('dark');
        updateDarkModeIcon(true);
      } else {
        html.classList.remove('dark');
        updateDarkModeIcon(false);
      }
    }

    // Toggle entre modo claro y oscuro
    function toggleDarkMode() {
      const isDark = html.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateDarkModeIcon(isDark);
    }

    // Event listener para el botÃ³n
    darkModeToggle.addEventListener('click', toggleDarkMode);

    // Inicializar modo oscuro al cargar
    initDarkMode();

    // Detectar iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    
    if (isIOS) {
      document.getElementById('ios-instructions').classList.remove('hidden');
      console.log('ğŸ“± Dispositivo iOS detectado');
    }
    
    // Variables globales
    let userId = localStorage.getItem('userId') || `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('userId', userId);
    
    let userName = localStorage.getItem('userName') || '';
    let groupName = localStorage.getItem('groupName') || '';
    let serverUrl = localStorage.getItem('serverUrl') || 'wss://gps-tracker-server-production-5900.up.railway.app';
    let voiceEnabled = localStorage.getItem('voiceEnabled') === 'true';
    let visualizerMode = localStorage.getItem('visualizerMode') === 'true';
    let minSpeedThreshold = parseFloat(localStorage.getItem('minSpeedThreshold')) || 22;
    let lastAnnouncedSpeed = -1;
    let lastAnnouncementTime = 0;
    const announcementCooldownMs = 3000; // 3 seconds between announcements
    let ws = null;
    let watchId = null;
    let isTracking = false;
    let users = [];
    let wakeLock = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 10;
    
    // Variables para estadÃ­sticas
    let maxSpeed = 0;
    let speedReadings = [];
    
    // Variables para el mapa
    let map = null;
    let mapFullscreen = null;
    let userMarkers = {};
    let userTracks = {};
    let trackPolylines = {};
    let mapVisible = false;
    let isFullscreen = false;

    // Elementos DOM
    const elements = {
      userId: document.getElementById('user-id'),
      userName: document.getElementById('user-name'),
      groupName: document.getElementById('group-name'),
      serverUrl: document.getElementById('server-url'),
      configSection: document.getElementById('config-section'),
      statusSection: document.getElementById('status-section'),
      gpsStatusContainer: document.getElementById('gps-status-container'),
      wifiIcon: document.getElementById('wifi-icon'),
      connectionStatus: document.getElementById('connection-status'),
      gpsIcon: document.getElementById('gps-icon'),
      gpsStatus: document.getElementById('gps-status'),
      speedDisplay: document.getElementById('speed-display'),
      maxSpeed: document.getElementById('max-speed'),
      avgSpeed: document.getElementById('avg-speed'),
      errorBox: document.getElementById('error-box'),
      successBox: document.getElementById('success-box'),
      gpsInfo: document.getElementById('gps-info'),
      trackButton: document.getElementById('track-button'),
      stopButton: document.getElementById('stop-button'),
      resetStatsButton: document.getElementById('reset-stats-button'),
      groupHornButton: document.getElementById('group-horn-button'),
      userCount: document.getElementById('user-count'),
      usersList: document.getElementById('users-list'),
      accuracy: document.getElementById('accuracy'),
      coords: document.getElementById('coords'),
      wakeLockStatus: document.getElementById('wake-lock-status'),
      mapContainer: document.getElementById('map-container'),
      toggleMapButton: document.getElementById('toggle-map-button'),
      closeMapButton: document.getElementById('close-map-button'),
      clearTracksButton: document.getElementById('clear-tracks-button'),
      fullscreenButton: document.getElementById('fullscreen-button'),
      exitFullscreenButton: document.getElementById('exit-fullscreen-button'),
      mapFullscreen: document.getElementById('map-fullscreen'),
      settingsButton: document.getElementById('settings-button'),
      settingsModal: document.getElementById('settings-modal'),
      closeSettings: document.getElementById('close-settings'),
      historyButton: document.getElementById('history-button'),
      historyModal: document.getElementById('history-modal'),
      closeHistory: document.getElementById('close-history'),
      historyTotalRecords: document.getElementById('history-total-records'),
      historyHighestSpeed: document.getElementById('history-highest-speed'),
      historyAverageMax: document.getElementById('history-average-max'),
      historyLoading: document.getElementById('history-loading'),
      historyEmpty: document.getElementById('history-empty'),
      historyRecordsList: document.getElementById('history-records-list'),
      languageSelect: document.getElementById('language-select'),
      languageLabel: document.getElementById('language-label'),
      autoCenterToggle: document.getElementById('auto-center-toggle'),
      voiceEnabledToggle: document.getElementById('voice-enabled-toggle'),
      visualizerModeToggle: document.getElementById('visualizer-mode-toggle'),
      visualizerModeIndicator: document.getElementById('visualizer-mode-indicator'),
      visualizerModeText: document.getElementById('visualizer-mode-text'),
      minSpeedInput: document.getElementById('min-speed-input')
    };

    // Inicializar
    elements.userId.textContent = userId.substring(0, 30);
    elements.userName.value = userName;
    elements.groupName.value = groupName;
    elements.serverUrl.value = serverUrl;
    elements.languageSelect.value = currentLanguage;

    // Load auto-center preference (default: true)
    const autoCenterEnabled = localStorage.getItem('autoCenterMap') !== 'false';
    elements.autoCenterToggle.checked = autoCenterEnabled;

    // Load voice announcement preferences
    elements.voiceEnabledToggle.checked = voiceEnabled;
    elements.minSpeedInput.value = minSpeedThreshold;

    // Load visualizer mode preference
    elements.visualizerModeToggle.checked = visualizerMode;

    // Initialize UI language on load
    updateUILanguage();

    // Initialize visualizer mode indicator
    updateVisualizerModeIndicator();

    // VERIFICACIÃ“N CRÃTICA
    console.log('ğŸ” VERIFICACIÃ“N DE ELEMENTOS:');
    console.log('config-section:', !!elements.configSection, elements.configSection);
    console.log('status-section:', !!elements.statusSection, elements.statusSection);
    console.log('track-button:', !!elements.trackButton, elements.trackButton);
    console.log('stop-button:', !!elements.stopButton, elements.stopButton);
    
    if (!elements.stopButton) {
      console.error('âŒ ERROR CRÃTICO: stop-button NO EXISTE en el DOM!');
    } else {
      console.log('âœ… stop-button encontrado correctamente');
    }

    // Guardar nombre cuando cambie
    elements.userName.addEventListener('input', (e) => {
      userName = e.target.value.trim();
      localStorage.setItem('userName', userName);
    });

    // Guardar grupo cuando cambie
    elements.groupName.addEventListener('input', (e) => {
      groupName = e.target.value.trim();
      localStorage.setItem('groupName', groupName);
    });

    // Guardar URL del servidor
    elements.serverUrl.addEventListener('change', (e) => {
      serverUrl = e.target.value.trim();
      localStorage.setItem('serverUrl', serverUrl);
    });

    // Language selector
    elements.languageSelect.addEventListener('change', (e) => {
      currentLanguage = e.target.value;
      localStorage.setItem('language', currentLanguage);
      updateUILanguage();
      console.log('ğŸŒ Language changed to:', currentLanguage);
    });

    // Auto-center toggle
    elements.autoCenterToggle.addEventListener('change', (e) => {
      const isEnabled = e.target.checked;
      localStorage.setItem('autoCenterMap', isEnabled);
      console.log('ğŸ—ºï¸ Auto-center map:', isEnabled ? 'enabled' : 'disabled');
    });

    // Voice announcements toggle
    elements.voiceEnabledToggle.addEventListener('change', (e) => {
      voiceEnabled = e.target.checked;
      localStorage.setItem('voiceEnabled', voiceEnabled);
      console.log('ğŸ”Š Voice announcements:', voiceEnabled ? 'enabled' : 'disabled');
    });

    // Visualizer mode toggle
    elements.visualizerModeToggle.addEventListener('change', (e) => {
      visualizerMode = e.target.checked;
      localStorage.setItem('visualizerMode', visualizerMode);
      console.log('ğŸ‘ï¸ Visualizer mode:', visualizerMode ? 'enabled' : 'disabled');
      updateVisualizerModeIndicator();
    });

    // Min speed threshold
    elements.minSpeedInput.addEventListener('change', (e) => {
      minSpeedThreshold = parseFloat(e.target.value) || 22;
      localStorage.setItem('minSpeedThreshold', minSpeedThreshold);
      console.log('ğŸ¯ Min speed threshold:', minSpeedThreshold, 'km/h');
    });

    // Modal de configuraciÃ³n
    elements.settingsButton.addEventListener('click', () => {
      elements.settingsModal.classList.remove('hidden');
    });

    elements.closeSettings.addEventListener('click', () => {
      elements.settingsModal.classList.add('hidden');
    });

    elements.settingsModal.addEventListener('click', (e) => {
      if (e.target === elements.settingsModal) {
        elements.settingsModal.classList.add('hidden');
      }
    });

    // History modal
    elements.historyButton.addEventListener('click', () => {
      elements.historyModal.classList.remove('hidden');
      loadSpeedHistory();
    });

    elements.closeHistory.addEventListener('click', () => {
      elements.historyModal.classList.add('hidden');
    });

    elements.historyModal.addEventListener('click', (e) => {
      if (e.target === elements.historyModal) {
        elements.historyModal.classList.add('hidden');
      }
    });

    // Resetear estadÃ­sticas
    elements.resetStatsButton.addEventListener('click', () => {
      maxSpeed = 0;
      speedReadings = [];
      elements.maxSpeed.textContent = '0.0';
      elements.avgSpeed.textContent = '0.0';
      showSuccess(t('statsReset'));
      console.log('ğŸ”„ EstadÃ­sticas reseteadas');
    });

    // FunciÃ³n para generar y reproducir sonido de bocina potente
    function playHornSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Crear osciladores para un sonido de bocina mÃ¡s realista y potente
        const oscillator1 = audioContext.createOscillator();
        const oscillator2 = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        // Frecuencias de bocina de auto (mÃ¡s graves y potentes)
        oscillator1.type = 'sawtooth';
        oscillator1.frequency.setValueAtTime(220, audioContext.currentTime); // A3

        oscillator2.type = 'sawtooth';
        oscillator2.frequency.setValueAtTime(330, audioContext.currentTime); // E4

        // Conectar osciladores al gain
        oscillator1.connect(gainNode);
        oscillator2.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Volumen inicial alto con fade out
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.8, audioContext.currentTime + 0.05); // Ataque rÃ¡pido
        gainNode.gain.exponentialRampToValueAtTime(0.6, audioContext.currentTime + 0.5); // Sostener
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.5); // Fade out

        // Iniciar sonido
        oscillator1.start(audioContext.currentTime);
        oscillator2.start(audioContext.currentTime);

        // Detener despuÃ©s de 1.5 segundos
        oscillator1.stop(audioContext.currentTime + 1.5);
        oscillator2.stop(audioContext.currentTime + 1.5);

        console.log('ğŸ“¢ Bocina reproducida');
      } catch (error) {
        console.error('âŒ Error reproduciendo bocina:', error);
        showError('Error al reproducir bocina: ' + error.message);
      }
    }

    // Voice speed announcement function
    function announceSpeed(speed) {
      if (!voiceEnabled || !('speechSynthesis' in window)) {
        return;
      }

      const speedInt = Math.round(speed);

      // Check if speed is above threshold
      if (speedInt < minSpeedThreshold) {
        return;
      }

      // Check cooldown
      const currentTime = Date.now();
      if (speedInt === lastAnnouncedSpeed ||
          (currentTime - lastAnnouncementTime) < announcementCooldownMs) {
        return;
      }

      // Stop any ongoing speech
      if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
      }

      // Create and speak the announcement
      const utterance = new SpeechSynthesisUtterance(speedInt.toString());

      // Set language based on current language
      const langMap = {
        'es': 'es-ES',
        'en': 'en-US',
        'fr': 'fr-FR',
        'de': 'de-DE'
      };
      utterance.lang = langMap[currentLanguage] || 'en-US';
      utterance.rate = 1.0;
      utterance.pitch = 1.0;
      utterance.volume = 1.0;

      window.speechSynthesis.speak(utterance);

      // Update tracking variables
      lastAnnouncedSpeed = speedInt;
      lastAnnouncementTime = currentTime;

      console.log('ğŸ”Š Speed announced:', speedInt, 'km/h');
    }

    // BotÃ³n de bocina grupal
    elements.groupHornButton.addEventListener('click', () => {
      if (!isTracking) {
        showError(t('mustBeTracking'));
        return;
      }

      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showError(t('noConnection'));
        return;
      }

      // Enviar seÃ±al de bocina a todos los usuarios del grupo
      ws.send(JSON.stringify({
        type: 'group-horn',
        userId,
        userName: userName || 'Usuario',
        groupName: groupName || 'default',
        timestamp: Date.now()
      }));

      // Reproducir sonido localmente tambiÃ©n
      playHornSound();
      showSuccess(t('hornActivated'));
      console.log('ğŸ“¢ SeÃ±al de bocina enviada al grupo:', groupName || 'default');
    });

    // Inicializar mapa con Leaflet (OpenStreetMap)
    function initMap(lat, lon, container = 'map') {
      const targetMap = container === 'map-fullscreen-container' ? 'mapFullscreen' : 'map';
      
      if (eval(targetMap)) return; // Ya estÃ¡ inicializado
      
      const mapInstance = L.map(container).setView([lat, lon], 15);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(mapInstance);
      
      if (targetMap === 'mapFullscreen') {
        mapFullscreen = mapInstance;
      } else {
        map = mapInstance;
      }
      
      console.log('âœ“ Mapa inicializado:', container);
    }

    // Calcular Ã¡ngulo de direcciÃ³n entre dos puntos
    function calculateBearing(lat1, lon1, lat2, lon2) {
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
      const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
      const bearing = Math.atan2(y, x) * 180 / Math.PI;
      return (bearing + 360) % 360;
    }

    // Crear icono de flecha para direcciÃ³n con velocidad y nombre visible
    function createArrowIcon(speed, isCurrentUser, bearing = 0, userName = '') {
      const color = isCurrentUser ? '#4F46E5' : '#10B981';
      const size = isCurrentUser ? 40 : 35;
      const displayName = userName || 'Usuario';

      const html = `
        <div style="position: relative; width: ${size}px; height: ${size}px; display: flex; align-items: center; justify-content: center;">
          <div style="position: absolute; top: -45px; left: 50%; transform: translateX(-50%); background: ${color}; color: white; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 1000; text-align: center; line-height: 1.3;">
            <div style="font-size: 10px; opacity: 0.9;">${displayName}</div>
            <div style="font-size: 13px; margin-top: 1px;">${parseFloat(speed).toFixed(1)} km/h</div>
          </div>
          <svg width="${size}" height="${size}" viewBox="0 0 24 24" style="transform: rotate(${bearing}deg); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));">
            <path d="M12 2 L4 20 L12 16 L20 20 Z" fill="${color}" stroke="white" stroke-width="1.5"/>
          </svg>
        </div>
      `;

      return L.divIcon({
        html: html,
        className: '',
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
        popupAnchor: [0, -size/2]
      });
    }

    // Actualizar mapa con posiciones de usuarios
    function updateMap() {
      const activeMap = isFullscreen ? mapFullscreen : map;
      if (!activeMap || (!mapVisible && !isFullscreen)) return;

      console.log('ğŸ—ºï¸ Actualizando mapa con', users.length, 'usuarios');

      users.forEach(user => {
        const isCurrentUser = user.userId === userId;
        const markerId = user.userId + (isFullscreen ? '_fs' : '_normal');
        
        console.log('ğŸ“ Procesando usuario:', user.userName || user.userId, 'Pos:', user.lat, user.lon);
        
        // Crear o actualizar marcador
        if (!userMarkers[markerId]) {
          console.log('âœ¨ Creando nuevo marcador para:', markerId);

          try {
            const displayName = user.userName || user.userId.substring(0, 15);
            const icon = createArrowIcon(user.speed, isCurrentUser, user.bearing || 0, displayName);
            const marker = L.marker([user.lat, user.lon], { icon: icon }).addTo(activeMap);

            marker.bindPopup(`
              <div style="text-align: center;">
                <strong>${displayName}</strong><br>
                <span style="font-size: 18px; font-weight: bold;">${parseFloat(user.speed).toFixed(1)} km/h</span><br>
                <span style="font-size: 14px;">ğŸ† Max: ${parseFloat(user.maxSpeed || 0).toFixed(1)} km/h</span><br>
                <span style="font-size: 11px; color: #666;">${new Date(user.timestamp).toLocaleTimeString()}</span>
              </div>
            `);

            userMarkers[markerId] = marker;
            userTracks[markerId] = [];

            console.log('âœ… Marcador creado exitosamente');
          } catch (error) {
            console.error('âŒ Error creando marcador:', error);
          }
        } else {
          // Actualizar posiciÃ³n y rotaciÃ³n
          try {
            const displayName = user.userName || user.userId.substring(0, 15);
            const marker = userMarkers[markerId];
            marker.setLatLng([user.lat, user.lon]);
            marker.setIcon(createArrowIcon(user.speed, isCurrentUser, user.bearing || 0, displayName));

            marker.setPopupContent(`
              <div style="text-align: center;">
                <strong>${displayName}</strong><br>
                <span style="font-size: 18px; font-weight: bold;">${parseFloat(user.speed).toFixed(1)} km/h</span><br>
                <span style="font-size: 14px;">ğŸ† Max: ${parseFloat(user.maxSpeed || 0).toFixed(1)} km/h</span><br>
                <span style="font-size: 11px; color: #666;">${new Date(user.timestamp).toLocaleTimeString()}</span>
              </div>
            `);
          } catch (error) {
            console.error('âŒ Error actualizando marcador:', error);
          }
        }
        
        // Agregar punto a la trayectoria solo si velocidad > 3.6 km/h
        if (user.speed > 3.6) {
          const track = userTracks[markerId];
          if (track) {
            track.push([user.lat, user.lon]);
            
            if (track.length > 50) {
              track.shift();
            }
            
            const polylineId = markerId + '_polyline';
            if (trackPolylines[polylineId]) {
              activeMap.removeLayer(trackPolylines[polylineId]);
            }
            
            if (track.length > 1) {
              const color = isCurrentUser ? '#4F46E5' : '#10B981';
              try {
                trackPolylines[polylineId] = L.polyline(track, {
                  color: color,
                  weight: 3,
                  opacity: 0.7,
                  smoothFactor: 1
                }).addTo(activeMap);
              } catch (error) {
                console.error('âŒ Error dibujando polyline:', error);
              }
            }
          }
        }
      });

      // Eliminar marcadores de usuarios desconectados
      Object.keys(userMarkers).forEach(markerId => {
        const userId = markerId.replace('_fs', '').replace('_normal', '');
        const mapType = markerId.includes('_fs') ? 'fs' : 'normal';
        
        if (!users.find(u => u.userId === userId) || 
            (isFullscreen && mapType === 'normal') || 
            (!isFullscreen && mapType === 'fs')) {
          try {
            activeMap.removeLayer(userMarkers[markerId]);
            delete userMarkers[markerId];
            delete userTracks[markerId];
            
            const polylineId = markerId + '_polyline';
            if (trackPolylines[polylineId]) {
              activeMap.removeLayer(trackPolylines[polylineId]);
              delete trackPolylines[polylineId];
            }
          } catch (error) {
            console.error('âŒ Error eliminando marcador:', error);
          }
        }
      });

      // Centrar en el usuario actual si existe y auto-center estÃ¡ habilitado
      const currentUser = users.find(u => u.userId === userId);
      const autoCenterEnabled = localStorage.getItem('autoCenterMap') !== 'false';
      if (currentUser && autoCenterEnabled) {
        activeMap.setView([currentUser.lat, currentUser.lon], activeMap.getZoom());
      }
    }

    // Limpiar tracks del mapa
    function clearMapTracks() {
      const activeMap = isFullscreen ? mapFullscreen : map;
      if (!activeMap) return;

      // Eliminar todas las polylines
      Object.keys(trackPolylines).forEach(uid => {
        if (trackPolylines[uid]) {
          activeMap.removeLayer(trackPolylines[uid]);
          delete trackPolylines[uid];
        }
      });

      // Vaciar arrays de tracks
      Object.keys(userTracks).forEach(uid => {
        userTracks[uid] = [];
      });

      showSuccess(t('tracksCleaned'));
      console.log('ğŸ—‘ï¸ Tracks del mapa limpiados');
    }

    // Toggle mapa
    elements.toggleMapButton.addEventListener('click', () => {
      mapVisible = true;
      elements.mapContainer.classList.remove('hidden');
      
      // Inicializar mapa con posiciÃ³n del primer usuario disponible
      const firstUser = users.length > 0 ? users[0] : null;
      if (firstUser) {
        initMap(firstUser.lat, firstUser.lon);
        updateMap();
      } else if (users.length === 0) {
        initMap(40.4168, -3.7038); // Madrid por defecto
      }
      
      // Ajustar tamaÃ±o del mapa
      setTimeout(() => {
        if (map) map.invalidateSize();
      }, 100);
    });

    elements.closeMapButton.addEventListener('click', () => {
      mapVisible = false;
      elements.mapContainer.classList.add('hidden');
    });

    // Pantalla completa
    elements.fullscreenButton.addEventListener('click', () => {
      isFullscreen = true;
      elements.mapContainer.classList.add('hidden'); // Ocultar mapa normal
      elements.mapFullscreen.classList.remove('hidden');
      
      const firstUser = users.length > 0 ? users[0] : null;
      if (firstUser) {
        initMap(firstUser.lat, firstUser.lon, 'map-fullscreen-container');
        setTimeout(() => {
          updateMap();
        }, 200);
      } else {
        initMap(40.4168, -3.7038, 'map-fullscreen-container');
      }
      
      setTimeout(() => {
        if (mapFullscreen) mapFullscreen.invalidateSize();
      }, 100);
    });

    elements.exitFullscreenButton.addEventListener('click', () => {
      isFullscreen = false;
      elements.mapFullscreen.classList.add('hidden');
      elements.mapContainer.classList.remove('hidden'); // Mostrar mapa normal
      
      // Limpiar marcadores del mapa fullscreen
      Object.keys(userMarkers).forEach(markerId => {
        if (markerId.includes('_fs') && mapFullscreen) {
          mapFullscreen.removeLayer(userMarkers[markerId]);
          delete userMarkers[markerId];
          delete userTracks[markerId];
          
          const polylineId = `${markerId}_polyline`;
          if (trackPolylines[polylineId]) {
            mapFullscreen.removeLayer(trackPolylines[polylineId]);
            delete trackPolylines[polylineId];
          }
        }
      });
      
      // Actualizar mapa normal
      setTimeout(() => {
        if (map) {
          map.invalidateSize();
          updateMap();
        }
      }, 100);
    });

    // Limpiar tracks
    elements.clearTracksButton.addEventListener('click', () => {
      clearMapTracks();
    });

    // Wake Lock API - Mantener pantalla encendida
    async function requestWakeLock() {
      if (!('wakeLock' in navigator)) {
        console.log('âš ï¸ Wake Lock no soportado en este navegador');
        if (isIOS) {
          showError(t('iosScreenError'));
        }
        return;
      }

      try {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log('âœ“ Wake Lock activado - Pantalla se mantendrÃ¡ encendida');
        elements.wakeLockStatus.classList.remove('hidden');
        showSuccess(t('screenLockedMsg'));

        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock liberado');
          elements.wakeLockStatus.classList.add('hidden');
        });
      } catch (err) {
        console.log('âŒ Wake Lock error:', err);
        if (isIOS) {
          showError(t('iosWakeLockError'));
        }
      }
    }

    // Liberar Wake Lock
    function releaseWakeLock() {
      if (wakeLock) {
        wakeLock.release().then(() => {
          wakeLock = null;
          elements.wakeLockStatus.classList.add('hidden');
          console.log('âœ“ Wake Lock liberado');
        });
      }
    }

    // Re-adquirir Wake Lock cuando la pÃ¡gina vuelve a estar visible
    document.addEventListener('visibilitychange', async () => {
      if (isTracking && !document.hidden && wakeLock === null) {
        console.log('â†» Reactivando Wake Lock...');
        await requestWakeLock();
      }
    });

    // Prevenir que el navegador pause la app
    let keepAliveInterval = null;
    function startKeepAlive() {
      // Ping cada 25 segundos para mantener la conexiÃ³n activa
      keepAliveInterval = setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'ping' }));
          console.log('ğŸ’“ Keep-alive ping');
        }
      }, 25000);
    }

    function stopKeepAlive() {
      if (keepAliveInterval) {
        clearInterval(keepAliveInterval);
        keepAliveInterval = null;
      }
    }

    // Mostrar error
    function showError(message) {
      console.error('âŒ', message);
      elements.errorBox.textContent = message;
      elements.errorBox.classList.remove('hidden');
      elements.successBox.classList.add('hidden');
      setTimeout(() => elements.errorBox.classList.add('hidden'), 8000);
    }

    // Mostrar Ã©xito
    function showSuccess(message) {
      console.log('âœ“', message);
      elements.successBox.textContent = message;
      elements.successBox.classList.remove('hidden');
      elements.errorBox.classList.add('hidden');
      setTimeout(() => elements.successBox.classList.add('hidden'), 3000);
    }

    // Actualizar estado de conexiÃ³n
    function updateConnectionStatus(connected) {
      elements.wifiIcon.textContent = connected ? 'âœ…' : 'âŒ';
      elements.connectionStatus.textContent = connected ? t('connected') : t('disconnected');
      elements.connectionStatus.className = `text-sm font-medium ${connected ? 'text-green-600' : 'text-red-600'}`;
    }

    // Actualizar estado GPS
    function updateGpsStatus(active) {
      elements.gpsIcon.textContent = active ? 'âœ…' : 'ğŸ“';
      elements.gpsStatus.textContent = active ? t('gpsActive') : t('gpsInactive');
      elements.gpsStatus.className = `text-sm font-medium ${active ? 'text-green-600' : 'text-gray-600'}`;
    }

    // Actualizar indicador de modo visualizador
    function updateVisualizerModeIndicator() {
      if (visualizerMode) {
        elements.visualizerModeIndicator.classList.remove('hidden');
        elements.visualizerModeText.textContent = t('visualizerModeActive');
      } else {
        elements.visualizerModeIndicator.classList.add('hidden');
      }
    }

    // Conectar WebSocket con reconexiÃ³n mejorada
    function connectWebSocket() {
      const serverUrl = elements.serverUrl.value;
      console.log('ğŸ”Œ Conectando a:', serverUrl);
      
      try {
        ws = new WebSocket(serverUrl);
        
        ws.onopen = () => {
          updateConnectionStatus(true);
          showSuccess(t('connectedToServer'));
          reconnectAttempts = 0;

          ws.send(JSON.stringify({
            type: 'register',
            userId,
            userName: userName || 'Usuario',
            groupName: groupName || 'default'
          }));
          console.log('âœ“ Registrado en servidor - Grupo:', groupName || 'default');

          startKeepAlive();
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'users') {
            users = data.users;
            updateUsersList();
            updateMap();
          } else if (data.type === 'pong') {
            console.log('ğŸ’“ Pong recibido');
          } else if (data.type === 'group-horn') {
            // Recibir seÃ±al de bocina de otro usuario del grupo
            const senderName = data.userName || 'Usuario';
            console.log('ğŸ“¢ Bocina recibida de:', senderName);

            // Solo reproducir si no es el usuario actual quien la enviÃ³
            if (data.userId !== userId) {
              playHornSound();
              showSuccess(t('hornReceived').replace('{name}', senderName));
            }
          }
        };

        ws.onerror = (error) => {
          console.error('âŒ Error WebSocket:', error);
          showError(t('connectionError'));
          updateConnectionStatus(false);
        };

        ws.onclose = () => {
          console.log('ğŸ”Œ ConexiÃ³n cerrada');
          updateConnectionStatus(false);
          stopKeepAlive();

          if (isTracking && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
            console.log(`â†» Reconectando en ${delay/1000}s (intento ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
            setTimeout(connectWebSocket, delay);
          } else if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
            showError(t('reconnectError'));
          }
        };
      } catch (error) {
        console.error('âŒ Error al crear WebSocket:', error);
        showError('No se pudo conectar: ' + error.message);
      }
    }

    // Actualizar lista de usuarios
    function updateUsersList() {
      elements.userCount.textContent = users.length;

      if (users.length === 0) {
        elements.usersList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center py-8">${t('noUsersConnected')}</p>`;
        return;
      }

      elements.usersList.innerHTML = users.map(user => {
        const displayName = user.userName || user.userId.substring(0, 15);
        const isCurrentUser = user.userId === userId;

        // Calcular direcciÃ³n en texto
        let direction = '';
        if (user.bearing !== undefined) {
          const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
          const index = Math.round(user.bearing / 45) % 8;
          direction = dirs[index];
        }

        return `
        <div class="p-4 rounded-lg border-2 ${isCurrentUser ? 'bg-indigo-50 dark:bg-indigo-900 border-indigo-300 dark:border-indigo-700' : 'bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600'} transition-colors">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-lg font-semibold text-gray-800 dark:text-white">${displayName}</span>
                ${isCurrentUser ? `<span class="text-xs bg-indigo-500 dark:bg-indigo-600 text-white px-2 py-1 rounded-full">${t('you')}</span>` : ''}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400 font-mono truncate">
                ID: ${user.userId.substring(0, 20)}...
              </div>
              <div class="flex items-center gap-3 mt-2 text-sm text-gray-600 dark:text-gray-400">
                <span>ğŸ§­ ${direction || '--'}</span>
                <span>ğŸ† ${parseFloat(user.maxSpeed || 0).toFixed(1)} km/h</span>
                <span class="text-xs">${new Date(user.timestamp).toLocaleTimeString()}</span>
              </div>
            </div>
            <div class="text-right ml-4">
              <div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${parseFloat(user.speed).toFixed(1)}</div>
              <div class="text-sm text-gray-600 dark:text-gray-400">km/h</div>
            </div>
          </div>
        </div>
      `}).join('');
    }

    // Iniciar seguimiento GPS
    function startTracking() {
      console.log('ğŸ¯ Iniciando seguimiento GPS...');

      // Validar nombre
      if (!userName || userName.trim() === '') {
        showError(t('enterName'));
        elements.userName.focus();
        return;
      }

      if (!navigator.geolocation) {
        showError(t('gpsNotAvailable'));
        return;
      }

      // Cambiar visibilidad
      elements.statusSection.classList.remove('hidden');
      elements.statusSection.style.display = 'block';
      elements.configSection.classList.add('hidden');
      elements.configSection.style.display = 'none';
      connectWebSocket();

      const options = {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      };

      let lastPosition = null;

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const speed = position.coords.speed !== null
            ? Math.max(0, (position.coords.speed * 3.6).toFixed(1))
            : '0.0';
          
          elements.speedDisplay.textContent = speed;
          updateGpsStatus(true);
          elements.gpsInfo.classList.remove('hidden');
          
          // Actualizar velocidad mÃ¡xima
          const speedNum = parseFloat(speed);
          if (speedNum > maxSpeed) {
            maxSpeed = speedNum;
            elements.maxSpeed.textContent = maxSpeed.toFixed(1);
          }
          
          // Actualizar promedio
          speedReadings.push(speedNum);
          if (speedReadings.length > 20) speedReadings.shift(); // Mantener Ãºltimos 20
          const avgSpeed = (speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length).toFixed(1);
          elements.avgSpeed.textContent = avgSpeed;

          // Voice announcement
          announceSpeed(speedNum);

          // Calcular direcciÃ³n/rumbo
          let bearing = 0;
          if (lastPosition && position.coords.speed > 1) { // Solo si hay movimiento
            bearing = calculateBearing(
              lastPosition.coords.latitude,
              lastPosition.coords.longitude,
              position.coords.latitude,
              position.coords.longitude
            );
          }
          
          const accuracy = Math.round(position.coords.accuracy);
          elements.accuracy.textContent = accuracy;
          elements.coords.textContent = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;

          // Send to WebSocket (only if not in visualizer mode)
          if (!visualizerMode && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'speed',
              userId,
              userName: userName || 'Usuario',
              groupName: groupName || 'default',
              speed: speedNum,
              maxSpeed,
              lat: position.coords.latitude,
              lon: position.coords.longitude,
              bearing: Math.round(bearing),
              timestamp: Date.now()
            }));
          }
          
          lastPosition = position;
        },
        (error) => {
          let errorMsg = '';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = t('permissionDenied');
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = t('positionUnavailable');
              break;
            case error.TIMEOUT:
              errorMsg = t('timeout');
              break;
            default:
              errorMsg = t('gpsError') + error.message;
          }
          showError(errorMsg);
          updateGpsStatus(false);
        },
        options
      );

      isTracking = true;
      elements.trackButton.textContent = t('stopTracking');
      elements.trackButton.className = 'w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-semibold py-3 px-6 rounded-lg transition-colors';
    }

    // Submit max speed record to server
    async function submitSpeedHistory() {
      if (maxSpeed > 0 && lastPosition) {
        try {
          const httpUrl = serverUrl.replace('wss://', 'https://').replace('ws://', 'http://');
          const response = await fetch(`${httpUrl}/api/speed-history`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              userId,
              userName: userName || 'Usuario',
              groupName: groupName || 'default',
              maxSpeed,
              latitude: lastPosition.coords.latitude,
              longitude: lastPosition.coords.longitude,
              timestamp: Date.now()
            })
          });

          if (response.ok) {
            console.log('âœ… Speed history record submitted successfully');
          } else {
            console.error('âŒ Failed to submit speed history:', response.status);
          }
        } catch (error) {
          console.error('âŒ Error submitting speed history:', error);
        }
      }
    }

    // Load speed history from server
    async function loadSpeedHistory() {
      try {
        elements.historyLoading.classList.remove('hidden');
        elements.historyEmpty.classList.add('hidden');
        elements.historyRecordsList.innerHTML = '';

        const httpUrl = serverUrl.replace('wss://', 'https://').replace('ws://', 'http://');

        // Load statistics
        const statsResponse = await fetch(`${httpUrl}/api/speed-history/${userId}/stats`);
        if (statsResponse.ok) {
          const statsData = await statsResponse.json();
          const stats = statsData.statistics;
          elements.historyTotalRecords.textContent = stats.total_records || '0';
          elements.historyHighestSpeed.textContent = parseFloat(stats.highest_speed || 0).toFixed(1);
          elements.historyAverageMax.textContent = parseFloat(stats.average_max_speed || 0).toFixed(1);
        }

        // Load history records
        const historyResponse = await fetch(`${httpUrl}/api/speed-history/${userId}?limit=50`);
        if (historyResponse.ok) {
          const historyData = await historyResponse.json();
          const records = historyData.records || [];

          elements.historyLoading.classList.add('hidden');

          if (records.length === 0) {
            elements.historyEmpty.classList.remove('hidden');
          } else {
            records.forEach(record => {
              const recordElement = document.createElement('div');
              recordElement.className = 'bg-white dark:bg-gray-700 rounded-lg p-3 border border-gray-200 dark:border-gray-600';
              recordElement.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                  <div class="text-sm font-semibold text-gray-800 dark:text-white">${record.date}</div>
                  <div class="text-lg font-bold text-red-600 dark:text-red-400">${parseFloat(record.max_speed).toFixed(1)} km/h</div>
                </div>
                <div class="flex justify-between items-center text-xs text-gray-600 dark:text-gray-400">
                  <div>${record.time}</div>
                  <div>${parseFloat(record.latitude).toFixed(4)}, ${parseFloat(record.longitude).toFixed(4)}</div>
                </div>
                ${record.group_name && record.group_name !== 'default' ? `<div class="text-xs text-gray-500 dark:text-gray-500 mt-1">Group: ${record.group_name}</div>` : ''}
              `;
              elements.historyRecordsList.appendChild(recordElement);
            });
          }
        } else {
          throw new Error('Failed to load history');
        }
      } catch (error) {
        console.error('âŒ Error loading speed history:', error);
        elements.historyLoading.classList.add('hidden');
        elements.historyEmpty.classList.remove('hidden');
        elements.historyEmpty.textContent = 'Error loading history: ' + error.message;
      }
    }

    // Detener seguimiento
    function stopTracking() {
      console.log('â¹ï¸ DETENIENDO SEGUIMIENTO');

      // Submit max speed record before stopping
      submitSpeedHistory();

      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      if (ws) {
        ws.close();
        ws = null;
      }

      stopKeepAlive();
      releaseWakeLock();

      isTracking = false;
      reconnectAttempts = 0;
      updateGpsStatus(false);
      updateConnectionStatus(false);
      elements.speedDisplay.textContent = '0.0';
      elements.gpsInfo.style.display = 'none';
      
      // Cambiar visibilidad
      elements.configSection.classList.remove('hidden');
      elements.configSection.style.display = 'block';
      elements.statusSection.classList.add('hidden');
      elements.statusSection.style.display = 'none';
      
      // Restaurar botÃ³n iniciar a su estilo original
      elements.trackButton.textContent = t('startTracking');
      elements.trackButton.className = 'flex-1 bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-semibold py-3 px-6 rounded-lg transition-colors';

      console.log('âœ… Status oculto, Config visible');
      console.log('âœ… SEGUIMIENTO DETENIDO');
    }

    // Eventos de los botones
    elements.trackButton.addEventListener('click', () => {
      startTracking();
    });

    elements.stopButton.addEventListener('click', () => {
      stopTracking();
    });

    // Limpiar al cerrar/recargar pÃ¡gina
    window.addEventListener('beforeunload', () => {
      if (isTracking) {
        stopTracking();
      }
    });

    console.log('âœ“ 3WB Tracker listo');
    console.log('ğŸ“± iOS:', isIOS, '| Standalone:', isStandalone);
  </script>
</body>
</html>
